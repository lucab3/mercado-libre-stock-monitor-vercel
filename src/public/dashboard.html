<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Monitor de Stock ML</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .nav-link {
            font-weight: 500;
            color: #333;
        }
        .nav-link.active {
            color: #007bff;
        }
        main {
            padding-top: 48px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-inactive {
            background-color: #dc3545;
        }
        .auto-refresh-info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .logout-btn {
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .sync-indicator {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .sync-indicator.syncing {
            color: #007bff;
        }
        .sync-indicator.error {
            color: #dc3545;
        }
        .last-updated {
            font-size: 0.75rem;
            color: #6c757d;
            font-style: italic;
        }
        .product-stock-realtime {
            font-weight: bold;
            color: #ffffff !important;
        }
        .product-stock-realtime.low {
            color: #ffc107;
        }
        .product-stock-realtime.empty {
            color: #dc3545;
        }
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* NUEVO: Estilos para enlaces a ML */
        .product-id-link {
            color: #007bff;
            text-decoration: none;
            font-family: monospace;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .product-id-link:hover {
            color: #0056b3;
            text-decoration: underline;
            transform: scale(1.05);
        }
        
        .ml-link-btn {
            background: linear-gradient(45deg, #FFF159, #FFE01B);
            border: none;
            color: #2c3e50;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        .ml-link-btn:hover {
            background: linear-gradient(45deg, #FFE01B, #FFF159);
            color: #2c3e50;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(255, 225, 27, 0.3);
        }
        
        .product-actions {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .product-title-container {
            max-width: 300px;
        }
        
        .product-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .product-meta {
            font-size: 0.75rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Monitor de Stock ML</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="logout-btn">
            <a href="/auth/logout" class="btn btn-sm btn-outline-light">
                <i class="bi bi-box-arrow-right"></i> Cerrar sesi√≥n
            </a>
        </div>
    </header>
    
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="sidebar-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-box-seam"></i> Productos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-gear"></i> Configuraci√≥n
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Indicador de sincronizaci√≥n -->
                    <div class="mt-3 px-3">
                        <small class="sync-indicator" id="sync-status">
                            <i class="bi bi-circle-fill"></i> Sincronizado
                        </small>
                        <div class="last-updated" id="last-sync-time">
                            √öltima actualizaci√≥n: Cargando...
                        </div>
                    </div>
                </div>
            </nav>
            
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Dashboard</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" id="start-monitoring" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-play-fill"></i> Iniciar monitoreo
                            </button>
                            <button type="button" id="stop-monitoring" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-stop-fill"></i> Detener monitoreo
                            </button>
                            <button type="button" id="check-now" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-search"></i> Verificar ahora
                            </button>
                        </div>
                        <div class="btn-group me-2">
                            <button type="button" id="force-changes" class="btn btn-sm btn-outline-warning">
                                <i class="bi bi-shuffle"></i> Forzar cambios
                            </button>
                            <button type="button" id="view-stats" class="btn btn-sm btn-outline-info">
                                <i class="bi bi-graph-up"></i> Ver estad√≠sticas
                            </button>
                        </div>
                        <button type="button" id="refresh-status" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-repeat"></i> Actualizar estado
                        </button>
                        <button type="button" onclick="debugSystem()" class="btn btn-sm btn-outline-warning" title="Debug completo del sistema">
                            <i class="bi bi-bug"></i> Debug Sistema
                        </button>
                        <button type="button" onclick="debugAllProducts()" class="btn btn-sm btn-outline-info" title="Ver todos los productos">
                            <i class="bi bi-list-check"></i> Todos los Productos
                        </button>
                        <button type="button" onclick="forceSyncClean()" class="btn btn-sm btn-outline-danger" title="Limpiar cache y sincronizar">
                            <i class="bi bi-arrow-clockwise"></i> Sync Completo
                        </button>
                        <button type="button" id="continue-scan-btn" onclick="continueProductScan()" class="btn btn-sm btn-success" title="Obtener siguientes productos" style="display: none;">
                            <i class="bi bi-plus-circle"></i> <span id="continue-scan-text">Obtener m√°s productos</span>
                        </button>
                    </div>
                </div>

                <!-- Informaci√≥n sobre monitoreo din√°mico -->
                <div class="auto-refresh-info">
                    <h6><i class="bi bi-info-circle"></i> Monitoreo en tiempo real</h6>
                    <p class="mb-1"><strong>API Real:</strong> Conectado a MercadoLibre con datos reales de tus publicaciones.</p>
                    <p class="mb-0"><strong>Controles:</strong> Usa "Verificar ahora" para actualizar datos o haz clic en cualquier ID/bot√≥n "ML" para ver la publicaci√≥n real.</p>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Estado del monitoreo</h5>
                                <p class="card-text">
                                    <span id="monitoring-status">
                                        <span class="status-indicator status-inactive"></span>
                                        Inactivo
                                    </span>
                                </p>
                                <p class="card-text">Umbral de stock bajo: <span id="stock-threshold">5</span> unidades</p>
                                <p class="card-text">Intervalo de verificaci√≥n: <span id="check-interval">15</span> minutos</p>
                                <p class="card-text">√öltima verificaci√≥n: <span id="last-check">Nunca</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Resumen</h5>
                                <p class="card-text">Total de productos: <span id="total-products">0</span> <span id="scan-progress" class="badge bg-info" style="display: none;"></span></p>
                                <p class="card-text">Productos con stock bajo: <span id="low-stock-products">0</span></p>
                                <p class="card-text">Pr√≥xima verificaci√≥n autom√°tica: <span id="next-auto-check">Al recargar la p√°gina</span></p>
                                <div id="scan-status" class="alert alert-info" style="display: none; margin-top: 10px; padding: 8px;">
                                    <small><i class="bi bi-info-circle"></i> <span id="scan-status-text"></span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h2>Productos con stock bajo</h2>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Producto</th>
                                <th>SKU</th>
                                <th>Stock</th>
                                <th>Estado</th>
                                <th>Publicaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="low-stock-table">
                            <tr>
                                <td colspan="7" class="text-center">Cargando informaci√≥n...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales para estado
        let lastKnownState = null;
        let isLoading = false;
        
        // Script para interactuar con la API - MEJORADO CON ENLACES A ML
        document.addEventListener('DOMContentLoaded', function() {
            // Comprobar estado inicial
            loadStatus();
            
            // Auto-refresh m√°s inteligente cada 15 segundos
            setInterval(loadStatus, 15000);
            
            // Eventos de botones
            document.getElementById('start-monitoring').addEventListener('click', startMonitoring);
            document.getElementById('stop-monitoring').addEventListener('click', stopMonitoring);
            document.getElementById('check-now').addEventListener('click', checkNow);
            document.getElementById('refresh-status').addEventListener('click', () => loadStatus(true));
            document.getElementById('force-changes').addEventListener('click', forceStockChanges);
            document.getElementById('view-stats').addEventListener('click', viewStats);
            
            function updateSyncStatus(status, message = '') {
                const syncElement = document.getElementById('sync-status');
                const timeElement = document.getElementById('last-sync-time');
                
                syncElement.className = `sync-indicator ${status}`;
                
                switch(status) {
                    case 'syncing':
                        syncElement.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Sincronizando...';
                        break;
                    case 'error':
                        syncElement.innerHTML = '<i class="bi bi-exclamation-circle-fill"></i> Error de sincronizaci√≥n';
                        break;
                    default:
                        syncElement.innerHTML = '<i class="bi bi-check-circle-fill"></i> Sincronizado';
                }
                
                if (message) {
                    timeElement.textContent = message;
                } else {
                    timeElement.textContent = '√öltima actualizaci√≥n: ' + new Date().toLocaleString();
                }
            }
            
            function loadStatus(forceRefresh = false) {
                if (isLoading && !forceRefresh) return;
                
                isLoading = true;
                updateSyncStatus('syncing');
                
                fetch('/api/auth/status')
                    .then(response => response.json())
                    .then(data => {
                        if (!data.authenticated) {
                            window.location.href = '/';
                            return;
                        }
                        
                        // Verificar si los datos han cambiado
                        const dataChanged = !lastKnownState || 
                                          JSON.stringify(data.monitoring.lowStockProducts) !== 
                                          JSON.stringify(lastKnownState.lowStockProducts);
                        
                        if (dataChanged || forceRefresh) {
                            console.log('üìä Datos actualizados:', data.monitoring);
                            updateMonitoringStatus(data.monitoring);
                            updateProductTable(data.monitoring.lowStockProducts || []);
                            lastKnownState = data.monitoring;
                        }
                        
                        updateSyncStatus('synced');
                        isLoading = false;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        updateSyncStatus('error', 'Error al sincronizar datos');
                        
                        // Mostrar error en la tabla solo si no hay datos previos
                        if (!lastKnownState) {
                            const tableBody = document.getElementById('low-stock-table');
                            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar informaci√≥n. <button class="btn btn-sm btn-link" onclick="loadStatus(true)">Reintentar</button></td></tr>';
                        }
                        
                        isLoading = false;
                    });
            }
            
            function startMonitoring() {
                const button = document.getElementById('start-monitoring');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Iniciando...';
                button.disabled = true;
                
                updateSyncStatus('syncing', 'Iniciando monitoreo...');
                
                fetch('/api/monitor/start', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Monitoreo iniciado correctamente');
                            loadStatus(true); // Forzar actualizaci√≥n inmediata
                        } else {
                            alert('Error al iniciar el monitoreo: ' + (data.error || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al iniciar el monitoreo');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            }
            
            function stopMonitoring() {
                updateSyncStatus('syncing', 'Deteniendo monitoreo...');
                
                fetch('/api/monitor/stop', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Monitoreo detenido correctamente');
                            loadStatus(true);
                        } else {
                            alert('Error al detener el monitoreo: ' + (data.error || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al detener el monitoreo');
                        updateSyncStatus('error');
                    });
            }
            
            function checkNow() {
                const button = document.getElementById('check-now');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Verificando...';
                button.disabled = true;
                
                updateSyncStatus('syncing', 'Verificando stock en tiempo real...');
                
                fetch('/api/monitor/check-now', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const result = data.result || {};
                            alert(`Verificaci√≥n completada. ${result.lowStockProducts || 0} productos con stock bajo de ${result.totalProducts || 0} total.`);
                            
                            // Actualizaci√≥n inmediata despu√©s de verificaci√≥n
                            setTimeout(() => loadStatus(true), 500);
                        } else {
                            alert('Error en la verificaci√≥n: ' + (data.error || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al verificar stock');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            }

            function forceStockChanges() {
                alert('Esta funci√≥n est√° disponible solo en modo de desarrollo con datos de prueba.');
            }

            function viewStats() {
                alert('Las estad√≠sticas est√°n disponibles en la consola del navegador y en los logs del servidor.');
            }
            
            function updateMonitoringStatus(monitoring) {
                const statusElement = document.getElementById('monitoring-status');
                const indicator = statusElement.querySelector('.status-indicator');
                
                if (monitoring.active) {
                    indicator.classList.remove('status-inactive');
                    indicator.classList.add('status-active');
                    statusElement.innerHTML = indicator.outerHTML + ' Activo';
                } else {
                    indicator.classList.remove('status-active');
                    indicator.classList.add('status-inactive');
                    statusElement.innerHTML = indicator.outerHTML + ' Inactivo';
                }
                
                // Actualizar otros elementos
                document.getElementById('stock-threshold').textContent = monitoring.threshold || '5';
                document.getElementById('check-interval').textContent = Math.floor((monitoring.checkInterval || 900000) / 60000);
                document.getElementById('total-products').textContent = monitoring.totalProducts || '0';
                document.getElementById('low-stock-products').textContent = (monitoring.lowStockProducts || []).length;
                
                // √öltima verificaci√≥n
                const lastCheck = monitoring.lastCheckTime;
                if (lastCheck) {
                    const date = new Date(lastCheck);
                    document.getElementById('last-check').textContent = date.toLocaleString();
                } else {
                    document.getElementById('last-check').textContent = 'Nunca';
                }
                
                // Pr√≥xima verificaci√≥n autom√°tica
                if (monitoring.active) {
                    document.getElementById('next-auto-check').textContent = 'Al recargar la p√°gina o en 15 min';
                } else {
                    document.getElementById('next-auto-check').textContent = 'Monitoreo inactivo';
                }
                
                // NUEVO: Manejo del bot√≥n de continuaci√≥n del scan
                updateScanControls(monitoring);
            }
            
            function updateScanControls(monitoring) {
                const continueBtn = document.getElementById('continue-scan-btn');
                const scanProgress = document.getElementById('scan-progress');
                const scanStatus = document.getElementById('scan-status');
                const scanStatusText = document.getElementById('scan-status-text');
                
                // Revisar si hay informaci√≥n del scan por lotes
                const scanInfo = monitoring.scanInfo || monitoring.batchInfo || null;
                
                if (scanInfo) {
                    // Mostrar informaci√≥n del scan por lotes
                    const totalProducts = monitoring.totalProducts || 0;
                    const hasMoreProducts = scanInfo.hasMoreProducts;
                    const scanCompleted = scanInfo.scanCompleted;
                    
                    if (hasMoreProducts && !scanCompleted) {
                        // Hay m√°s productos disponibles - mostrar bot√≥n
                        continueBtn.style.display = 'inline-block';
                        scanProgress.style.display = 'inline';
                        scanProgress.textContent = `Lote parcial (${totalProducts}/~2908)`;
                        scanProgress.className = 'badge bg-warning';
                        
                        scanStatus.style.display = 'block';
                        scanStatusText.textContent = `Tienes ${totalProducts} productos cargados de ~2908 totales. Haz clic en "Obtener m√°s productos" para continuar.`;
                        scanStatus.className = 'alert alert-warning';
                    } else if (scanCompleted) {
                        // Scan completado - ocultar bot√≥n
                        continueBtn.style.display = 'none';
                        scanProgress.style.display = 'inline';
                        scanProgress.textContent = 'Scan completo';
                        scanProgress.className = 'badge bg-success';
                        
                        scanStatus.style.display = 'block';
                        scanStatusText.textContent = `Scan completo: ${totalProducts} productos cargados.`;
                        scanStatus.className = 'alert alert-success';
                    } else {
                        // Estado intermedio
                        continueBtn.style.display = 'none';
                        scanProgress.style.display = 'none';
                        scanStatus.style.display = 'none';
                    }
                } else {
                    // Sin informaci√≥n de scan - ocultar controles
                    continueBtn.style.display = 'none';
                    scanProgress.style.display = 'none';
                    scanStatus.style.display = 'none';
                }
            }
            
            function updateProductTable(lowStockProducts) {
                const tableBody = document.getElementById('low-stock-table');
                
                if (!lowStockProducts || lowStockProducts.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-success">¬°Excelente! No hay productos con stock bajo.</td></tr>';
                    return;
                }
                
                console.log('üì¶ Actualizando tabla con productos:', lowStockProducts);
                
                tableBody.innerHTML = lowStockProducts.map(product => {
                    const stockClass = product.stock === 0 ? 'empty' : (product.stock <= 2 ? 'low' : '');
                    const statusClass = product.stock === 0 ? 'bg-danger' : 'bg-warning';
                    const statusText = product.stock === 0 ? 'Sin stock' : 'Stock bajo';
                    const trendIcon = product.stock === 0 ? 'üî¥' : product.stock <= 2 ? '‚ö†Ô∏è' : 'üì¶';
                    
                    // CORREGIDO: Usar productUrl validado del backend que incluye permalink real
                    const mlLink = product.productUrl || product.permalink || `https://articulo.mercadolibre.com.ar/${product.id}`;
                    
                    // NUEVO: Analizar tipo de enlace y estado de publicaci√≥n
                    const linkType = product.permalink ? 
                        (product.permalink.includes('internal-shop.mercadoshops.com.ar') ? 'mercadoshops' : 'standard') : 
                        'generated';
                    const linkIcon = linkType === 'mercadoshops' ? 'üè™' : (linkType === 'standard' ? 'üîó' : '‚öôÔ∏è');
                    
                    // Estado de publicaci√≥n
                    const pubStatus = product.status || 'unknown';
                    const pubStatusClass = pubStatus === 'active' ? 'bg-success' : 
                                          pubStatus === 'paused' ? 'bg-warning' : 'bg-danger';
                    const pubStatusText = pubStatus === 'active' ? 'Activa' : 
                                         pubStatus === 'paused' ? 'Pausada' : 
                                         pubStatus === 'closed' ? 'Cerrada' : 'Desconocido';
                    
                    // Debug de enlaces para verificar que est√°n correctos
                    console.log(`üîó Producto ${product.id}: URL = ${mlLink}, Tipo: ${linkType}, Estado: ${pubStatus}`);
                    if (product.permalink && product.productUrl && product.permalink !== product.productUrl) {
                        console.warn(`‚ö†Ô∏è Diferencia en enlaces para ${product.id}:`, {
                            permalink: product.permalink,
                            productUrl: product.productUrl
                        });
                    }
                    
                    return `
                        <tr>
                            <td>
                                <a href="${mlLink}" 
                                   target="_blank" 
                                   class="product-id-link" 
                                   title="Ver publicaci√≥n en MercadoLibre">
                                    ${product.id}
                                    <i class="bi bi-box-arrow-up-right" style="font-size: 0.7rem;"></i>
                                </a>
                                <div class="product-meta" style="font-size: 0.6rem; color: #888;">
                                    ${linkIcon} ${linkType === 'mercadoshops' ? 'MercadoShops' : linkType === 'standard' ? 'ML Est√°ndar' : 'Generado'}
                                    <button class="btn btn-xs btn-outline-secondary" onclick="debugProductDetails('${product.id}')" style="font-size: 0.5rem; padding: 1px 3px; margin-left: 5px;" title="Debug detalles">
                                        <i class="bi bi-bug"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="product-title-container">
                                <div class="product-title">${trendIcon} ${product.title}</div>
                                <div class="product-meta">Actualizado: ${new Date().toLocaleTimeString()}</div>
                            </td>
                            <td>
                                <span class="badge ${product.seller_sku ? 'bg-info' : 'bg-secondary'}" style="font-size: 0.75rem;">
                                    ${product.seller_sku || 'Sin SKU'}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${statusClass}">
                                    <span class="product-stock-realtime">${product.stock} unidades</span>
                                </span>
                            </td>
                            <td>
                                <span class="badge ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${pubStatusClass}" style="font-size: 0.75rem;">
                                    ${pubStatusText}
                                </span>
                                ${linkType === 'mercadoshops' ? '<div style="font-size: 0.6rem; color: #ff6b00;">üè™ MercadoShops</div>' : ''}
                            </td>
                            <td>
                                <div class="product-actions">
                                    <button class="btn btn-sm btn-outline-primary" onclick="checkProduct('${product.id}')" title="Verificar stock actual">
                                        <i class="bi bi-search"></i> Verificar
                                    </button>
                                    <a href="${mlLink}" 
                                       target="_blank" 
                                       class="btn btn-sm ml-link-btn" 
                                       title="Ver en MercadoLibre">
                                        <i class="bi bi-shop"></i> ML
                                    </a>
                                    <button class="btn btn-sm btn-outline-info" onclick="debugProduct('${product.id}')" title="Ver datos de debug">
                                        <i class="bi bi-bug"></i> Debug
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removePhantomProduct('${product.id}')" title="Eliminar si es fantasma">
                                        <i class="bi bi-trash"></i> Limpiar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Funci√≥n global para verificar producto espec√≠fico - MEJORADA CON ENLACES
            window.checkProduct = function(productId) {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                button.disabled = true;
                
                updateSyncStatus('syncing', `Verificando producto ${productId}...`);
                
                fetch(`/api/products/${productId}/stock`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                            updateSyncStatus('error');
                        } else {
                            const stockStatus = data.available_quantity === 0 ? 'Sin stock' : 
                                              data.has_low_stock ? 'Stock bajo' : 'Stock suficiente';
                            
                            // NUEVO: Incluir enlace y SKU en el alert
                            const mlLink = data.productUrl || data.permalink || `https://articulo.mercadolibre.com.ar/${data.id}`;
                            const skuInfo = data.seller_sku ? `\nSKU: ${data.seller_sku}` : '\nSKU: Sin SKU';
                            
                            alert(`Producto: ${data.title}${skuInfo}\nStock actual: ${data.available_quantity} unidades\nEstado: ${stockStatus}\n√öltima actualizaci√≥n: ${new Date(data.last_updated).toLocaleString()}\n\nüîó Ver en ML: ${mlLink}`);
                            
                            // Recargar estado despu√©s de verificaci√≥n individual
                            setTimeout(() => loadStatus(true), 500);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al verificar el producto');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            };
            
            // NUEVA: Funci√≥n global para debuggear detalles espec√≠ficos de un producto
            window.debugProductDetails = function(productId) {
                console.log('üêõ DEBUGGING DETALLES DE PRODUCTO:', productId);
                
                // Buscar el producto en los datos actuales
                const product = lastKnownState?.lowStockProducts?.find(p => p.id === productId);
                if (product) {
                    console.log('üì¶ DATOS DEL PRODUCTO EN DASHBOARD:', {
                        id: product.id,
                        title: product.title,
                        stock: product.stock,
                        seller_sku: product.seller_sku,
                        permalink: product.permalink,
                        productUrl: product.productUrl,
                        linksMatch: product.permalink === product.productUrl
                    });
                    
                    // Mostrar alert con informaci√≥n de debug
                    const skuInfo = product.seller_sku ? `\nSKU: ${product.seller_sku}` : '\nSKU: Sin SKU';
                    const linkInfo = `\nPermalink: ${product.permalink || 'No disponible'}\nProductURL: ${product.productUrl || 'No disponible'}`;
                    const matchInfo = product.permalink && product.productUrl ? `\nEnlaces coinciden: ${product.permalink === product.productUrl ? 'S√ç' : 'NO'}` : '';
                    
                    alert(`DEBUG PRODUCTO ${productId}:\n\nT√≠tulo: ${product.title}${skuInfo}\nStock: ${product.stock}${linkInfo}${matchInfo}`);
                } else {
                    alert(`No se encontraron datos para el producto ${productId} en el estado actual del dashboard`);
                }
            };
            
            // NUEVA: Funci√≥n global para debug completo del sistema
            window.debugSystem = function() {
                console.log('üîß DEBUGGING COMPLETO DEL SISTEMA:');
                console.log('Estado actual:', lastKnownState);
                console.log('Productos con stock bajo:', lastKnownState?.lowStockProducts);
                
                if (lastKnownState?.lowStockProducts) {
                    lastKnownState.lowStockProducts.forEach(product => {
                        console.log(`üì¶ ${product.id}:`, {
                            title: product.title,
                            stock: product.stock,
                            seller_sku: product.seller_sku,
                            permalink: product.permalink,
                            productUrl: product.productUrl,
                            linksMatch: product.permalink === product.productUrl
                        });
                    });
                }
                
                alert('Debug completo enviado a la consola del navegador. Abre Developer Tools > Console para ver los detalles.');
            };
            
            // NUEVA: Funci√≥n para debuggear todos los productos
            window.debugAllProducts = function() {
                console.log('üîç Obteniendo informaci√≥n de TODOS los productos...');
                
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Cargando...';
                button.disabled = true;
                
                fetch('/debug/all-products')
                    .then(response => response.json())
                    .then(data => {
                        console.log('üìä INFORMACI√ìN COMPLETA DE PRODUCTOS:', data);
                        
                        // Mostrar resumen
                        const summary = data.summary;
                        let summaryText = `RESUMEN DE PRODUCTOS ${summary.scanMethod ? '(M√âTODO SCAN)' : ''}:\n\n`;
                        summaryText += `üìã Total de IDs encontrados: ${summary.totalIdsFound}\n`;
                        if (summary.sampleAnalyzed) {
                            summaryText += `üîç Muestra analizada: ${summary.sampleAnalyzed} de ${summary.totalIdsFound}\n`;
                        }
                        summaryText += `‚úÖ Cargados exitosamente: ${summary.successfullyLoaded}\n`;
                        summaryText += `‚ùå Errores: ${summary.errorProducts}\n`;
                        summaryText += `üè∑Ô∏è Con SKU: ${summary.withSKU}\n`;
                        summaryText += `üö´ Sin SKU: ${summary.withoutSKU}\n\n`;
                        
                        summaryText += `ESTADOS:\n`;
                        Object.entries(summary.byStatus).forEach(([status, count]) => {
                            summaryText += `- ${status}: ${count} productos\n`;
                        });
                        
                        summaryText += `\nTIPOS DE ENLACES:\n`;
                        Object.entries(summary.byLinkType).forEach(([type, count]) => {
                            summaryText += `- ${type}: ${count} productos\n`;
                        });
                        
                        if (data.errors && data.errors.length > 0) {
                            summaryText += `\n‚ùå PRODUCTOS CON ERRORES:\n`;
                            data.errors.forEach(error => {
                                summaryText += `- ${error.id}: ${error.error}\n`;
                            });
                        }
                        
                        alert(summaryText + '\n\nRevisa la consola para detalles completos.');
                        
                        // Buscar espec√≠ficamente el DDJ-200 problem√°tico
                        const ddj200Problem = data.productDetails.find(p => p.id === 'MLA1511790506');
                        if (ddj200Problem) {
                            console.warn('üéõÔ∏è PRODUCTO DDJ-200 PROBLEM√ÅTICO ENCONTRADO:', ddj200Problem);
                        } else {
                            console.warn('üéõÔ∏è PRODUCTO DDJ-200 (MLA1511790506) NO ENCONTRADO EN LA LISTA DE PRODUCTOS');
                            
                            // Buscar productos similares
                            const ddj200Similar = data.productDetails.filter(p => 
                                p.title && p.title.toLowerCase().includes('ddj')
                            );
                            if (ddj200Similar.length > 0) {
                                console.warn('üéõÔ∏è PRODUCTOS DDJ SIMILARES ENCONTRADOS:', ddj200Similar);
                            }
                        }
                        
                    })
                    .catch(error => {
                        console.error('‚ùå Error obteniendo todos los productos:', error);
                        alert('Error al obtener informaci√≥n de productos. Revisa la consola.');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            };
            
            // NUEVA: Funci√≥n para sincronizaci√≥n completa con limpieza de cache
            window.forceSyncClean = function() {
                if (!confirm('¬øEst√°s seguro? Esto limpiar√° todo el cache y volver√° a cargar todos los productos desde cero.')) {
                    return;
                }
                
                console.log('üßπ Iniciando sincronizaci√≥n completa con limpieza...');
                
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Limpiando...';
                button.disabled = true;
                
                updateSyncStatus('syncing', 'Limpiando cache y sincronizando...');
                
                fetch('/debug/force-sync', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('‚úÖ SINCRONIZACI√ìN COMPLETA:', data);
                        
                        if (data.success) {
                            alert(`Sincronizaci√≥n completa exitosa!\n\nTotal productos: ${data.result.totalProducts}\nProductos con stock bajo: ${data.result.lowStockProducts}\n\nCache limpiado y datos actualizados.`);
                            
                            // Forzar actualizaci√≥n del dashboard
                            setTimeout(() => loadStatus(true), 1000);
                        } else {
                            alert('Error en la sincronizaci√≥n: ' + (data.message || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error en sincronizaci√≥n:', error);
                        alert('Error al sincronizar. Revisa la consola.');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            };
            
            // NUEVA: Funci√≥n para eliminar un producto fantasma espec√≠fico
            window.removePhantomProduct = function(productId) {
                if (!confirm(`¬øEliminar el producto fantasma ${productId} del cache?`)) {
                    return;
                }
                
                console.log(`üîç Eliminando producto fantasma: ${productId}`);
                
                fetch(`/debug/remove-phantom-product/${productId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('‚úÖ PRODUCTO FANTASMA ELIMINADO:', data);
                        
                        if (data.success) {
                            alert(`Producto fantasma ${productId} eliminado del cache.\n\nResultados:\n- Estaba en tracked: ${data.cleanupResults.wasInTracked}\n- Estaba en state: ${data.cleanupResults.wasInState}\n- Estaba en low stock: ${data.cleanupResults.wasInLowStock}`);
                            
                            // Actualizar dashboard
                            setTimeout(() => loadStatus(true), 500);
                        } else {
                            alert('Error eliminando producto fantasma: ' + (data.message || 'Error desconocido'));
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error eliminando producto fantasma:', error);
                        alert('Error al eliminar producto fantasma. Revisa la consola.');
                    });
            };
            
            // NUEVA: Funci√≥n para continuar el scan de productos
            window.continueProductScan = function() {
                console.log('üîÑ Continuando scan de productos...');
                
                const button = document.getElementById('continue-scan-btn');
                const buttonText = document.getElementById('continue-scan-text');
                const originalText = buttonText.innerHTML;
                
                buttonText.innerHTML = 'Obteniendo...';
                button.disabled = true;
                
                updateSyncStatus('syncing', 'Obteniendo m√°s productos...');
                
                fetch('/api/products/continue-scan', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('‚úÖ CONTINUACI√ìN DE SCAN:', data);
                        
                        if (data.success) {
                            const result = data.scanResult;
                            const newProductsCount = result.newProducts || 0; // Solo productos nuevos
                            const totalProducts = result.total || 0; // Total acumulado
                            
                            alert(`¬°Scan continuado exitosamente!\n\n` +
                                  `${newProductsCount} productos nuevos obtenidos\n` +
                                  `Total acumulado: ${totalProducts} productos\n` +
                                  `Scan completado: ${result.scanCompleted ? 'S√ç' : 'NO'}\n` +
                                  `M√°s productos disponibles: ${result.hasMoreProducts ? 'S√ç' : 'NO'}`);
                            
                            // Actualizar el dashboard inmediatamente
                            setTimeout(() => loadStatus(true), 1000);
                            
                            updateSyncStatus('success', `${newProductsCount} productos nuevos obtenidos (total: ${totalProducts})`);
                        } else {
                            alert('Error continuando scan: ' + (data.message || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error continuando scan:', error);
                        alert('Error al continuar scan. Revisa la consola.');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        buttonText.innerHTML = originalText;
                        button.disabled = false;
                    });
            };
            
            // Hacer funciones de debug disponibles globalmente
            console.log('üêõ FUNCIONES DE DEBUG DISPONIBLES:');
            console.log('- debugProductDetails(productId): Debug de un producto espec√≠fico');
            console.log('- debugSystem(): Debug completo del sistema');
            console.log('- debugAllProducts(): Ver TODOS los productos del usuario');
            console.log('- forceSyncClean(): Sincronizaci√≥n completa con limpieza');
            console.log('- removePhantomProduct(productId): Eliminar producto fantasma');
            console.log('- Para usar: debugSystem() o debugProductDetails("MLA1234567890")');
        });
    </script>
</body>
</html>