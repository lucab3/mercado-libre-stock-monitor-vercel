<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Monitor de Stock ML</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .nav-link {
            font-weight: 500;
            color: #333;
        }
        .nav-link.active {
            color: #007bff;
        }
        main {
            padding-top: 48px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-inactive {
            background-color: #dc3545;
        }
        .auto-refresh-info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .sync-indicator {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .sync-indicator.syncing {
            color: #007bff;
        }
        .sync-indicator.error {
            color: #dc3545;
        }
        .last-updated {
            font-size: 0.75rem;
            color: #6c757d;
            font-style: italic;
        }
        .product-stock-realtime {
            font-weight: bold;
            color: #ffffff !important;
        }
        .product-stock-realtime.low {
            color: #ffc107;
        }
        .product-stock-realtime.empty {
            color: #dc3545;
        }
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* NUEVO: Estilos para enlaces a ML */
        .product-id-link {
            color: #007bff;
            text-decoration: none;
            font-family: monospace;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .product-id-link:hover {
            color: #0056b3;
            text-decoration: underline;
            transform: scale(1.05);
        }
        
        .ml-link-btn {
            background: linear-gradient(45deg, #FFF159, #FFE01B);
            border: none;
            color: #2c3e50;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        .ml-link-btn:hover {
            background: linear-gradient(45deg, #FFE01B, #FFF159);
            color: #2c3e50;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(255, 225, 27, 0.3);
        }
        
        .product-actions {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .product-title-container {
            max-width: 300px;
        }
        
        .product-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .product-meta {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .filter-controls {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .filter-group .form-select {
            min-width: 150px;
        }
        
        .category-filters {
            max-width: 400px;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
            padding: 1rem;
        }
        
        .category-checkboxes {
            max-height: 300px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: white;
            border: 1px solid #e9ecef;
            transition: background-color 0.2s;
        }
        
        .category-item:hover {
            background-color: #e3f2fd;
        }
        
        .category-item.has-subcategories {
            border-left: 3px solid #007bff;
        }
        
        .category-checkbox {
            margin-right: 0.5rem;
        }
        
        .category-name {
            font-size: 0.85rem;
            flex-grow: 1;
        }
        
        .category-path {
            font-size: 0.75rem;
            color: #6c757d;
            margin-left: 0.5rem;
        }
        
        .subcategory-item {
            margin-left: 1rem;
            border-left: 2px solid #28a745;
            background-color: #f0f9ff;
        }
        
        @media (max-width: 768px) {
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .category-checkboxes {
                grid-template-columns: 1fr;
            }
            
            .category-filters {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Monitor de Stock ML</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-nav flex-row">
            <div class="nav-item text-nowrap me-3">
                <span class="navbar-text text-light">
                    <i class="bi bi-person-circle"></i> <span id="current-user">Cargando...</span>
                </span>
            </div>
            <div class="nav-item text-nowrap">
                <a href="/auth/logout" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </a>
            </div>
        </div>
    </header>
    
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="sidebar-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-box-seam"></i> Productos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-gear"></i> Configuración
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Indicador de sincronización -->
                    <div class="mt-3 px-3">
                        <small class="sync-indicator" id="sync-status">
                            <i class="bi bi-circle-fill"></i> Sincronizado
                        </small>
                        <div class="last-updated" id="last-sync-time">
                            Última actualización: Cargando...
                        </div>
                    </div>
                </div>
            </nav>
            
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Dashboard</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" id="start-monitoring" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-play-fill"></i> Iniciar monitoreo
                            </button>
                            <button type="button" id="stop-monitoring" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-stop-fill"></i> Detener monitoreo
                            </button>
                        </div>
                        <button type="button" id="refresh-status" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-repeat"></i> Actualizar estado
                        </button>
                        <button type="button" id="continue-scan-btn" onclick="continueProductScan()" class="btn btn-sm btn-success" title="Obtener siguientes productos" style="display: none;">
                            <i class="bi bi-plus-circle"></i> <span id="continue-scan-text">Obtener más productos</span>
                        </button>
                    </div>
                </div>

                <!-- Información sobre monitoreo dinámico -->
                <div class="auto-refresh-info">
                    <h6><i class="bi bi-info-circle"></i> Monitoreo en tiempo real</h6>
                    <p class="mb-1"><strong>API Real:</strong> Conectado a MercadoLibre con datos reales de tus publicaciones.</p>
                    <p class="mb-0"><strong>Controles:</strong> Usa "Verificar ahora" para actualizar datos o haz clic en cualquier ID/botón "ML" para ver la publicación real.</p>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Estado del monitoreo</h5>
                                <p class="card-text">
                                    <span id="monitoring-status">
                                        <span class="status-indicator status-inactive"></span>
                                        Inactivo
                                    </span>
                                </p>
                                <p class="card-text">Umbral de stock bajo: <span id="stock-threshold">5</span> unidades</p>
                                <p class="card-text">Intervalo de verificación: <span id="check-interval">15</span> minutos</p>
                                <p class="card-text">Última verificación: <span id="last-check">Nunca</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Resumen</h5>
                                <p class="card-text">Total de productos: <span id="total-products">0</span> <span id="scan-progress" class="badge bg-info" style="display: none;"></span></p>
                                <p class="card-text">Productos con stock bajo: <span id="low-stock-products">0</span></p>
                                <p class="card-text">Próxima verificación automática: <span id="next-auto-check">Al recargar la página</span></p>
                                <div id="scan-status" class="alert alert-info" style="display: none; margin-top: 10px; padding: 8px;">
                                    <small><i class="bi bi-info-circle"></i> <span id="scan-status-text"></span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Productos con stock bajo</h2>
                    <div class="filter-controls">
                        <div class="filter-group me-3">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <label class="form-label me-2 mb-0">Filtrar categorías:</label>
                                <button type="button" id="clear-categories" class="btn btn-sm btn-outline-secondary" title="Limpiar filtros de categorías">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </button>
                                <button type="button" id="toggle-categories" class="btn btn-sm btn-outline-info" title="Mostrar/Ocultar filtros">
                                    <i class="bi bi-funnel"></i> <span id="toggle-text">Mostrar</span>
                                </button>
                            </div>
                            <div id="category-filters" class="category-filters" style="display: none;">
                                <div id="category-loading" class="text-center p-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Cargando categorías...</span>
                                    </div>
                                    <div class="mt-2">Obteniendo categorías...</div>
                                </div>
                                <div id="category-checkboxes" class="category-checkboxes" style="display: none;">
                                    <!-- Se cargan dinámicamente -->
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="stock-filter" class="form-label me-2">Ordenar por stock:</label>
                            <select id="stock-filter" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                                <option value="default">Sin ordenar</option>
                                <option value="stock-asc">Menor a mayor stock</option>
                                <option value="stock-desc">Mayor a menor stock</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Producto</th>
                                <th>SKU</th>
                                <th>Stock</th>
                                <th>Estado</th>
                                <th>Publicación</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="low-stock-table">
                            <tr>
                                <td colspan="7" class="text-center">Cargando información...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales para estado
        let lastKnownState = null;
        let isLoading = false;
        let originalProductsData = []; // Para mantener los datos originales sin filtrar
        let availableCategories = new Map(); // Para mapear category_id a información de categoría
        let categoriesCache = new Map(); // Cache de categorías obtenidas de la API
        let categoriesLoaded = false;
        
        // Script para interactuar con la API - MEJORADO CON ENLACES A ML
        document.addEventListener('DOMContentLoaded', function() {
            // Comprobar estado inicial
            loadStatus();
            
            // Auto-refresh más inteligente cada 15 segundos (pero se pausa durante scans)
            let autoRefreshInterval = setInterval(loadStatus, 15000);
            let scanInProgress = false;
            
            // Eventos de botones
            document.getElementById('start-monitoring').addEventListener('click', startMonitoring);
            document.getElementById('stop-monitoring').addEventListener('click', stopMonitoring);
            document.getElementById('refresh-status').addEventListener('click', () => loadStatus(true));
            document.getElementById('stock-filter').addEventListener('change', applyFilters);
            document.getElementById('toggle-categories').addEventListener('click', toggleCategoryFilters);
            document.getElementById('clear-categories').addEventListener('click', clearCategoryFilters);
            
            function updateSyncStatus(status, message = '') {
                const syncElement = document.getElementById('sync-status');
                const timeElement = document.getElementById('last-sync-time');
                
                syncElement.className = `sync-indicator ${status}`;
                
                switch(status) {
                    case 'syncing':
                        syncElement.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Sincronizando...';
                        break;
                    case 'error':
                        syncElement.innerHTML = '<i class="bi bi-exclamation-circle-fill"></i> Error de sincronización';
                        break;
                    default:
                        syncElement.innerHTML = '<i class="bi bi-check-circle-fill"></i> Sincronizado';
                }
                
                if (message) {
                    timeElement.textContent = message;
                } else {
                    timeElement.textContent = 'Última actualización: ' + new Date().toLocaleString();
                }
            }
            
            function updateUserInfo(userInfo) {
                const userElement = document.getElementById('current-user');
                
                if (userInfo) {
                    // Preferir nickname si está disponible, sino usar ID
                    let displayName = '';
                    
                    if (userInfo.nickname) {
                        displayName = userInfo.nickname;
                    } else if (userInfo.sessionInfo && userInfo.sessionInfo.userId) {
                        displayName = userInfo.sessionInfo.userId;
                    } else if (userInfo.id) {
                        displayName = userInfo.id;
                    } else {
                        displayName = 'Usuario desconocido';
                    }
                    
                    userElement.textContent = displayName;
                } else {
                    userElement.textContent = 'Usuario desconocido';
                }
            }
            
            function loadStatus(forceRefresh = false) {
                if (isLoading && !forceRefresh) return;
                
                isLoading = true;
                updateSyncStatus('syncing');
                
                fetch('/api/auth/status')
                    .then(response => response.json())
                    .then(data => {
                        if (!data.authenticated) {
                            window.location.href = '/';
                            return;
                        }
                        
                        // Verificar si los datos han cambiado
                        const dataChanged = !lastKnownState || 
                                          JSON.stringify(data.monitoring.lowStockProducts) !== 
                                          JSON.stringify(lastKnownState.lowStockProducts);
                        
                        if (dataChanged || forceRefresh) {
                            console.log('📊 Datos actualizados:', data.monitoring);
                            updateMonitoringStatus(data.monitoring);
                            updateProductTable(data.monitoring.lowStockProducts || []);
                            lastKnownState = data.monitoring;
                        }
                        
                        // Actualizar información del usuario
                        updateUserInfo(data.user);
                        
                        updateSyncStatus('synced');
                        isLoading = false;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        updateSyncStatus('error', 'Error al sincronizar datos');
                        
                        // Mostrar error en la tabla solo si no hay datos previos
                        if (!lastKnownState) {
                            const tableBody = document.getElementById('low-stock-table');
                            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar información. <button class="btn btn-sm btn-link" onclick="loadStatus(true)">Reintentar</button></td></tr>';
                        }
                        
                        isLoading = false;
                    });
            }
            
            function startMonitoring() {
                const button = document.getElementById('start-monitoring');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Iniciando...';
                button.disabled = true;
                
                updateSyncStatus('syncing', 'Iniciando monitoreo...');
                
                fetch('/api/monitor/start', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Monitoreo iniciado correctamente');
                            loadStatus(true); // Forzar actualización inmediata
                        } else {
                            alert('Error al iniciar el monitoreo: ' + (data.error || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al iniciar el monitoreo');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            }
            
            function stopMonitoring() {
                updateSyncStatus('syncing', 'Deteniendo monitoreo...');
                
                fetch('/api/monitor/stop', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Monitoreo detenido correctamente');
                            loadStatus(true);
                        } else {
                            alert('Error al detener el monitoreo: ' + (data.error || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al detener el monitoreo');
                        updateSyncStatus('error');
                    });
            }
            

            
            function updateMonitoringStatus(monitoring) {
                const statusElement = document.getElementById('monitoring-status');
                const indicator = statusElement.querySelector('.status-indicator');
                
                if (monitoring.active) {
                    indicator.classList.remove('status-inactive');
                    indicator.classList.add('status-active');
                    statusElement.innerHTML = indicator.outerHTML + ' Activo';
                } else {
                    indicator.classList.remove('status-active');
                    indicator.classList.add('status-inactive');
                    statusElement.innerHTML = indicator.outerHTML + ' Inactivo';
                }
                
                // MEJORADO: Actualizar elementos con validación de datos
                document.getElementById('stock-threshold').textContent = monitoring.threshold || '5';
                document.getElementById('check-interval').textContent = Math.floor((monitoring.checkInterval || 900000) / 60000);
                
                // CRÍTICO: Asegurar que totalProducts se actualice correctamente
                const totalProducts = monitoring.totalProducts || '0';
                const lowStockCount = (monitoring.lowStockProducts || []).length;
                
                const totalElement = document.getElementById('total-products');
                const lowStockElement = document.getElementById('low-stock-products');
                
                // Log para debugging de actualizaciones
                console.log(`📊 Actualizando contadores: Total=${totalProducts}, BajoStock=${lowStockCount}`);
                
                totalElement.textContent = totalProducts;
                lowStockElement.textContent = lowStockCount;
                
                // NUEVO: Forzar repintado del DOM para asegurar que se visualicen los cambios
                totalElement.style.fontWeight = 'bold';
                lowStockElement.style.fontWeight = 'bold';
                setTimeout(() => {
                    totalElement.style.fontWeight = 'normal';
                    lowStockElement.style.fontWeight = 'normal';
                }, 500);
                
                // Última verificación
                const lastCheck = monitoring.lastCheckTime;
                if (lastCheck) {
                    const date = new Date(lastCheck);
                    document.getElementById('last-check').textContent = date.toLocaleString();
                } else {
                    document.getElementById('last-check').textContent = 'Nunca';
                }
                
                // Próxima verificación automática
                if (monitoring.active) {
                    document.getElementById('next-auto-check').textContent = 'Al recargar la página o en 15 min';
                } else {
                    document.getElementById('next-auto-check').textContent = 'Monitoreo inactivo';
                }
                
                // NUEVO: Manejo del botón de continuación del scan
                updateScanControls(monitoring);
            }
            
            function updateScanControls(monitoring) {
                const continueBtn = document.getElementById('continue-scan-btn');
                const scanProgress = document.getElementById('scan-progress');
                const scanStatus = document.getElementById('scan-status');
                const scanStatusText = document.getElementById('scan-status-text');
                
                // Revisar si hay información del scan por lotes
                const scanInfo = monitoring.scanInfo || monitoring.batchInfo || null;
                const totalProducts = monitoring.totalProducts || 0;
                
                console.log('🔍 updateScanControls - scanInfo:', scanInfo);
                console.log('🔍 updateScanControls - totalProducts:', totalProducts);
                
                if (scanInfo) {
                    // Mostrar información del scan por lotes
                    const hasMoreProducts = scanInfo.hasMoreProducts;
                    const scanCompleted = scanInfo.scanCompleted;
                    
                    console.log(`🔍 Scan status: completed=${scanCompleted}, hasMore=${hasMoreProducts}, total=${totalProducts}`);
                    
                    if (hasMoreProducts && !scanCompleted) {
                        // Hay más productos disponibles - mostrar botón
                        continueBtn.style.display = 'inline-block';
                        scanProgress.style.display = 'inline';
                        scanProgress.textContent = `${totalProducts} productos cargados`;
                        scanProgress.className = 'badge bg-warning';
                        
                        scanStatus.style.display = 'block';
                        scanStatusText.textContent = `Tienes ${totalProducts} productos cargados. Cada click obtiene más productos. Haz clic en "Obtener más productos" para continuar.`;
                        scanStatus.className = 'alert alert-warning';
                        
                        console.log('✅ Mostrando botón de continuar scan');
                    } else if (scanCompleted || (!hasMoreProducts && totalProducts > 0)) {
                        // Scan completado - ocultar botón y mostrar estado final
                        continueBtn.style.display = 'none';
                        scanProgress.style.display = 'inline';
                        scanProgress.textContent = 'Todos los productos obtenidos';
                        scanProgress.className = 'badge bg-success';
                        
                        scanStatus.style.display = 'block';
                        scanStatusText.textContent = `✅ Scan completo: ${totalProducts} productos cargados. No hay más productos disponibles.`;
                        scanStatus.className = 'alert alert-success';
                        
                        console.log('✅ Scan completado - ocultando botón de continuar');
                    } else {
                        // Estado intermedio - probablemente primer scan
                        if (totalProducts > 0) {
                            // Mostrar información básica pero sin botón hasta confirmar estado
                            continueBtn.style.display = 'none';
                            scanProgress.style.display = 'inline';
                            scanProgress.textContent = `${totalProducts} productos`;
                            scanProgress.className = 'badge bg-info';
                            
                            scanStatus.style.display = 'block';
                            scanStatusText.textContent = `${totalProducts} productos cargados. Verificando si hay más disponibles...`;
                            scanStatus.className = 'alert alert-info';
                        } else {
                            // Sin productos aún
                            continueBtn.style.display = 'none';
                            scanProgress.style.display = 'none';
                            scanStatus.style.display = 'none';
                        }
                        
                        console.log('ℹ️ Estado intermedio de scan');
                    }
                } else {
                    // Sin información de scan - posiblemente primer carga
                    if (totalProducts > 0) {
                        // Hay productos pero sin info de scan, mostrar info básica
                        continueBtn.style.display = 'none';
                        scanProgress.style.display = 'inline';
                        scanProgress.textContent = `${totalProducts} productos`;
                        scanProgress.className = 'badge bg-secondary';
                        
                        scanStatus.style.display = 'none';
                        console.log('ℹ️ Productos encontrados sin info de scan');
                    } else {
                        // Sin información de scan ni productos - ocultar controles
                        continueBtn.style.display = 'none';
                        scanProgress.style.display = 'none';
                        scanStatus.style.display = 'none';
                        console.log('ℹ️ Sin información de scan - ocultando controles');
                    }
                }
            }
            
            function applyFilters() {
                let filteredProducts = [...originalProductsData];
                
                // 1. Aplicar filtro de categorías primero
                const selectedCheckboxes = document.querySelectorAll('#category-checkboxes .category-checkbox:checked');
                const selectedCategories = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
                
                if (selectedCategories.length > 0) {
                    filteredProducts = filteredProducts.filter(product => 
                        selectedCategories.includes(product.category_id)
                    );
                }
                
                // 2. Aplicar ordenamiento por stock
                const stockFilterValue = document.getElementById('stock-filter').value;
                
                switch(stockFilterValue) {
                    case 'stock-asc':
                        filteredProducts.sort((a, b) => a.stock - b.stock);
                        break;
                    case 'stock-desc':
                        filteredProducts.sort((a, b) => b.stock - a.stock);
                        break;
                    case 'default':
                    default:
                        // Mantener orden original (después del filtro de categorías)
                        break;
                }
                
                renderProductTable(filteredProducts);
                
                // Actualizar contador de productos filtrados
                updateFilteredCount(filteredProducts.length, originalProductsData.length);
            }
            
            function clearCategoryFilters() {
                const checkboxes = document.querySelectorAll('#category-checkboxes .category-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                applyFilters(); // Reaplicar filtros
            }
            
            function toggleCategoryFilters() {
                const categoryFilters = document.getElementById('category-filters');
                const toggleText = document.getElementById('toggle-text');
                const isVisible = categoryFilters.style.display !== 'none';
                
                if (isVisible) {
                    categoryFilters.style.display = 'none';
                    toggleText.textContent = 'Mostrar';
                } else {
                    categoryFilters.style.display = 'block';
                    toggleText.textContent = 'Ocultar';
                    
                    // Solo cargar categorías la primera vez que se muestran
                    if (!categoriesLoaded) {
                        loadCategoriesInfo();
                    }
                }
            }
            
            function updateAvailableCategories(products) {
                // Limpiar categorías previas
                availableCategories.clear();
                
                // Extraer categorías únicas de los productos
                products.forEach(product => {
                    if (product.category_id) {
                        // Solo agregar si no está ya en la cache
                        if (!categoriesCache.has(product.category_id)) {
                            availableCategories.set(product.category_id, getCategoryDisplayName(product.category_id));
                        } else {
                            // Usar información de la cache si está disponible
                            const cachedCategory = categoriesCache.get(product.category_id);
                            availableCategories.set(product.category_id, cachedCategory.name);
                        }
                    }
                });
                
                // Si las categorías están visibles y cargadas, actualizar la interfaz
                if (categoriesLoaded && document.getElementById('category-filters').style.display !== 'none') {
                    updateCategorySelector();
                }
            }
            
            async function loadCategoriesInfo() {
                const categoryLoading = document.getElementById('category-loading');
                const categoryCheckboxes = document.getElementById('category-checkboxes');
                
                categoryLoading.style.display = 'block';
                categoryCheckboxes.style.display = 'none';
                
                try {
                    // Obtener categorías únicas de los productos actuales
                    const uniqueCategoryIds = [...new Set(originalProductsData
                        .map(product => product.category_id)
                        .filter(id => id)
                    )];
                    
                    if (uniqueCategoryIds.length === 0) {
                        categoryLoading.innerHTML = '<div class="text-center p-3"><i class="bi bi-info-circle"></i><div class="mt-2">No hay categorías para mostrar</div></div>';
                        return;
                    }
                    
                    // Filtrar categorías que no están en cache
                    const categoriesToFetch = uniqueCategoryIds.filter(id => !categoriesCache.has(id));
                    
                    if (categoriesToFetch.length > 0) {
                        console.log(`🔍 Obteniendo información de ${categoriesToFetch.length} categorías desde la API...`);
                        
                        const response = await fetch('/api/categories/info', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ categoryIds: categoriesToFetch })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Error HTTP: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.success && data.categories) {
                            // Guardar en cache
                            data.categories.forEach(category => {
                                categoriesCache.set(category.id, {
                                    id: category.id,
                                    name: category.name,
                                    path_from_root: category.path_from_root || [],
                                    children_categories: category.children_categories || []
                                });
                            });
                            
                            console.log(`✅ Información de ${data.categories.length} categorías guardada en cache`);
                        } else {
                            throw new Error(data.message || 'Error en la respuesta del servidor');
                        }
                    } else {
                        console.log('📋 Todas las categorías ya están en cache');
                    }
                    
                    // Actualizar availableCategories con información de la cache
                    uniqueCategoryIds.forEach(categoryId => {
                        const cachedCategory = categoriesCache.get(categoryId);
                        if (cachedCategory) {
                            availableCategories.set(categoryId, cachedCategory.name);
                        } else {
                            availableCategories.set(categoryId, getCategoryDisplayName(categoryId));
                        }
                    });
                    
                    categoriesLoaded = true;
                    categoryLoading.style.display = 'none';
                    categoryCheckboxes.style.display = 'block';
                    
                    // Actualizar la interfaz de checkboxes
                    updateCategorySelector();
                    
                } catch (error) {
                    console.error('❌ Error cargando información de categorías:', error);
                    categoryLoading.innerHTML = `
                        <div class="text-center p-3 text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            <div class="mt-2">Error cargando categorías</div>
                            <small>${error.message}</small>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadCategoriesInfo()">Reintentar</button>
                        </div>
                    `;
                }
            }
            
            function getCategoryDisplayName(categoryId) {
                // Mapeo básico de algunos category_ids conocidos a nombres amigables (fallback)
                const categoryNames = {
                    'MLM1055': 'Celulares y Teléfonos',
                    'MLM1648': 'Computación', 
                    'MLM1144': 'Consolas y Videojuegos',
                    'MLM1000': 'Electrónicos',
                    'MLM1403': 'Instrumentos Musicales',
                    'MLM1276': 'Deportes y Fitness',
                    'MLM1430': 'Ropa y Accesorios',
                    'MLM1132': 'Juegos y Juguetes',
                    'MLM1367': 'Industrias y Oficinas',
                    'MLM1039': 'Cámaras y Accesorios'
                };
                
                return categoryNames[categoryId] || `Categoría ${categoryId}`;
            }
            
            function updateCategorySelector() {
                const categoryCheckboxes = document.getElementById('category-checkboxes');
                const currentSelection = Array.from(document.querySelectorAll('#category-checkboxes .category-checkbox:checked'))
                    .map(checkbox => checkbox.value);
                
                // Limpiar checkboxes actuales
                categoryCheckboxes.innerHTML = '';
                
                // Agregar categorías disponibles ordenadas
                const sortedCategories = Array.from(availableCategories.entries())
                    .sort((a, b) => a[1].localeCompare(b[1])); // Ordenar por nombre
                
                sortedCategories.forEach(([categoryId, categoryName]) => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item';
                    
                    // Verificar si tiene subcategorías
                    const cachedCategory = categoriesCache.get(categoryId);
                    const hasSubcategories = cachedCategory && cachedCategory.children_categories && 
                                            cachedCategory.children_categories.length > 0;
                    
                    if (hasSubcategories) {
                        categoryItem.classList.add('has-subcategories');
                    }
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'category-checkbox';
                    checkbox.value = categoryId;
                    checkbox.addEventListener('change', applyFilters);
                    
                    // Mantener selección previa si existe
                    if (currentSelection.includes(categoryId)) {
                        checkbox.checked = true;
                    }
                    
                    const label = document.createElement('label');
                    label.className = 'category-name';
                    label.textContent = categoryName;
                    label.addEventListener('click', () => {
                        checkbox.checked = !checkbox.checked;
                        applyFilters();
                    });
                    
                    // Mostrar path si está disponible
                    if (cachedCategory && cachedCategory.path_from_root && cachedCategory.path_from_root.length > 1) {
                        const pathSpan = document.createElement('span');
                        pathSpan.className = 'category-path';
                        const pathNames = cachedCategory.path_from_root.map(cat => cat.name).join(' > ');
                        pathSpan.textContent = pathNames;
                        categoryItem.appendChild(checkbox);
                        categoryItem.appendChild(label);
                        categoryItem.appendChild(pathSpan);
                    } else {
                        categoryItem.appendChild(checkbox);
                        categoryItem.appendChild(label);
                    }
                    
                    categoryCheckboxes.appendChild(categoryItem);
                    
                    // Agregar subcategorías si existen
                    if (hasSubcategories) {
                        cachedCategory.children_categories.forEach(subcat => {
                            const subcategoryItem = document.createElement('div');
                            subcategoryItem.className = 'category-item subcategory-item';
                            
                            const subCheckbox = document.createElement('input');
                            subCheckbox.type = 'checkbox';
                            subCheckbox.className = 'category-checkbox';
                            subCheckbox.value = subcat.id;
                            subCheckbox.addEventListener('change', applyFilters);
                            
                            if (currentSelection.includes(subcat.id)) {
                                subCheckbox.checked = true;
                            }
                            
                            const subLabel = document.createElement('label');
                            subLabel.className = 'category-name';
                            subLabel.textContent = `↳ ${subcat.name}`;
                            subLabel.addEventListener('click', () => {
                                subCheckbox.checked = !subCheckbox.checked;
                                applyFilters();
                            });
                            
                            subcategoryItem.appendChild(subCheckbox);
                            subcategoryItem.appendChild(subLabel);
                            categoryCheckboxes.appendChild(subcategoryItem);
                        });
                    }
                });
            }
            
            function updateFilteredCount(filtered, total) {
                // Actualizar el texto del header para mostrar filtros aplicados
                const header = document.querySelector('h2');
                if (filtered === total) {
                    header.textContent = 'Productos con stock bajo';
                } else {
                    header.textContent = `Productos con stock bajo (${filtered} de ${total} mostrados)`;
                }
            }
            
            function updateProductTable(lowStockProducts) {
                // Guardar datos originales
                originalProductsData = lowStockProducts || [];
                
                // Actualizar categorías disponibles
                updateAvailableCategories(originalProductsData);
                
                // Aplicar filtros actuales
                applyFilters();
            }
            
            function renderProductTable(lowStockProducts) {
                const tableBody = document.getElementById('low-stock-table');
                
                if (!lowStockProducts || lowStockProducts.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-success">¡Excelente! No hay productos con stock bajo.</td></tr>';
                    return;
                }
                
                console.log('📦 Actualizando tabla con productos:', lowStockProducts);
                
                tableBody.innerHTML = lowStockProducts.map(product => {
                    const stockClass = product.stock === 0 ? 'empty' : (product.stock <= 2 ? 'low' : '');
                    const statusClass = product.stock === 0 ? 'bg-danger' : 'bg-warning';
                    const statusText = product.stock === 0 ? 'Sin stock' : 'Stock bajo';
                    const trendIcon = product.stock === 0 ? '🔴' : product.stock <= 2 ? '⚠️' : '📦';
                    
                    // CORREGIDO: Usar productUrl validado del backend que incluye permalink real
                    const mlLink = product.productUrl || product.permalink || `https://articulo.mercadolibre.com.ar/${product.id}`;
                    
                    // NUEVO: Analizar tipo de enlace y estado de publicación
                    const linkType = product.permalink ? 
                        (product.permalink.includes('internal-shop.mercadoshops.com.ar') ? 'mercadoshops' : 'standard') : 
                        'generated';
                    const linkIcon = linkType === 'mercadoshops' ? '🏪' : (linkType === 'standard' ? '🔗' : '⚙️');
                    
                    // Estado de publicación
                    const pubStatus = product.status || 'unknown';
                    const pubStatusClass = pubStatus === 'active' ? 'bg-success' : 
                                          pubStatus === 'paused' ? 'bg-warning' : 'bg-danger';
                    const pubStatusText = pubStatus === 'active' ? 'Activa' : 
                                         pubStatus === 'paused' ? 'Pausada' : 
                                         pubStatus === 'closed' ? 'Cerrada' : 'Desconocido';
                    
                    // Debug de enlaces para verificar que están correctos
                    console.log(`🔗 Producto ${product.id}: URL = ${mlLink}, Tipo: ${linkType}, Estado: ${pubStatus}`);
                    if (product.permalink && product.productUrl && product.permalink !== product.productUrl) {
                        console.warn(`⚠️ Diferencia en enlaces para ${product.id}:`, {
                            permalink: product.permalink,
                            productUrl: product.productUrl
                        });
                    }
                    
                    return `
                        <tr>
                            <td>
                                <a href="${mlLink}" 
                                   target="_blank" 
                                   class="product-id-link" 
                                   title="Ver publicación en MercadoLibre">
                                    ${product.id}
                                    <i class="bi bi-box-arrow-up-right" style="font-size: 0.7rem;"></i>
                                </a>
                                <div class="product-meta" style="font-size: 0.6rem; color: #888;">
                                    ${linkIcon} ${linkType === 'mercadoshops' ? 'MercadoShops' : linkType === 'standard' ? 'ML Estándar' : 'Generado'}
                                    <button class="btn btn-xs btn-outline-secondary" onclick="debugProductDetails('${product.id}')" style="font-size: 0.5rem; padding: 1px 3px; margin-left: 5px;" title="Debug detalles">
                                        <i class="bi bi-bug"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="product-title-container">
                                <div class="product-title">${trendIcon} ${product.title}</div>
                                <div class="product-meta">Actualizado: ${new Date().toLocaleTimeString()}</div>
                            </td>
                            <td>
                                <span class="badge ${product.seller_sku ? 'bg-info' : 'bg-secondary'}" style="font-size: 0.75rem;">
                                    ${product.seller_sku || 'Sin SKU'}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${statusClass}">
                                    <span class="product-stock-realtime">${product.stock} unidades</span>
                                </span>
                            </td>
                            <td>
                                <span class="badge ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${pubStatusClass}" style="font-size: 0.75rem;">
                                    ${pubStatusText}
                                </span>
                                ${linkType === 'mercadoshops' ? '<div style="font-size: 0.6rem; color: #ff6b00;">🏪 MercadoShops</div>' : ''}
                            </td>
                            <td>
                                <div class="product-actions">
                                    <button class="btn btn-sm btn-outline-primary" onclick="checkProduct('${product.id}')" title="Verificar stock actual">
                                        <i class="bi bi-search"></i> Verificar
                                    </button>
                                    <a href="${mlLink}" 
                                       target="_blank" 
                                       class="btn btn-sm ml-link-btn" 
                                       title="Ver en MercadoLibre">
                                        <i class="bi bi-shop"></i> ML
                                    </a>
                                    <button class="btn btn-sm btn-outline-info" onclick="debugProduct('${product.id}')" title="Ver datos de debug">
                                        <i class="bi bi-bug"></i> Debug
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Función global para verificar producto específico - MEJORADA CON ENLACES
            window.checkProduct = function(productId) {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                button.disabled = true;
                
                updateSyncStatus('syncing', `Verificando producto ${productId}...`);
                
                fetch(`/api/products/${productId}/stock`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                            updateSyncStatus('error');
                        } else {
                            const stockStatus = data.available_quantity === 0 ? 'Sin stock' : 
                                              data.has_low_stock ? 'Stock bajo' : 'Stock suficiente';
                            
                            // NUEVO: Incluir enlace y SKU en el alert
                            const mlLink = data.productUrl || data.permalink || `https://articulo.mercadolibre.com.ar/${data.id}`;
                            const skuInfo = data.seller_sku ? `\nSKU: ${data.seller_sku}` : '\nSKU: Sin SKU';
                            
                            alert(`Producto: ${data.title}${skuInfo}\nStock actual: ${data.available_quantity} unidades\nEstado: ${stockStatus}\nÚltima actualización: ${new Date(data.last_updated).toLocaleString()}\n\n🔗 Ver en ML: ${mlLink}`);
                            
                            // Recargar estado después de verificación individual
                            setTimeout(() => loadStatus(true), 500);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al verificar el producto');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            };
            
            // NUEVA: Función global para debuggear detalles específicos de un producto
            window.debugProductDetails = function(productId) {
                console.log('🐛 DEBUGGING DETALLES DE PRODUCTO:', productId);
                
                // Buscar el producto en los datos actuales
                const product = lastKnownState?.lowStockProducts?.find(p => p.id === productId);
                if (product) {
                    console.log('📦 DATOS DEL PRODUCTO EN DASHBOARD:', {
                        id: product.id,
                        title: product.title,
                        stock: product.stock,
                        seller_sku: product.seller_sku,
                        permalink: product.permalink,
                        productUrl: product.productUrl,
                        linksMatch: product.permalink === product.productUrl
                    });
                    
                    // Mostrar alert con información de debug
                    const skuInfo = product.seller_sku ? `\nSKU: ${product.seller_sku}` : '\nSKU: Sin SKU';
                    const linkInfo = `\nPermalink: ${product.permalink || 'No disponible'}\nProductURL: ${product.productUrl || 'No disponible'}`;
                    const matchInfo = product.permalink && product.productUrl ? `\nEnlaces coinciden: ${product.permalink === product.productUrl ? 'SÍ' : 'NO'}` : '';
                    
                    alert(`DEBUG PRODUCTO ${productId}:\n\nTítulo: ${product.title}${skuInfo}\nStock: ${product.stock}${linkInfo}${matchInfo}`);
                } else {
                    alert(`No se encontraron datos para el producto ${productId} en el estado actual del dashboard`);
                }
            };
            
            // NUEVA: Función global para debug completo del sistema
            window.debugSystem = function() {
                console.log('🔧 DEBUGGING COMPLETO DEL SISTEMA:');
                console.log('Estado actual:', lastKnownState);
                console.log('Productos con stock bajo:', lastKnownState?.lowStockProducts);
                
                if (lastKnownState?.lowStockProducts) {
                    lastKnownState.lowStockProducts.forEach(product => {
                        console.log(`📦 ${product.id}:`, {
                            title: product.title,
                            stock: product.stock,
                            seller_sku: product.seller_sku,
                            permalink: product.permalink,
                            productUrl: product.productUrl,
                            linksMatch: product.permalink === product.productUrl
                        });
                    });
                }
                
                alert('Debug completo enviado a la consola del navegador. Abre Developer Tools > Console para ver los detalles.');
            };
            
            // NUEVA: Función para debuggear todos los productos
            window.debugAllProducts = function() {
                console.log('🔍 Obteniendo información de TODOS los productos...');
                
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Cargando...';
                button.disabled = true;
                
                fetch('/debug/all-products')
                    .then(response => response.json())
                    .then(data => {
                        console.log('📊 INFORMACIÓN COMPLETA DE PRODUCTOS:', data);
                        
                        // Mostrar resumen
                        const summary = data.summary;
                        let summaryText = `RESUMEN DE PRODUCTOS ${summary.scanMethod ? '(MÉTODO SCAN)' : ''}:\n\n`;
                        summaryText += `📋 Total de IDs encontrados: ${summary.totalIdsFound}\n`;
                        if (summary.sampleAnalyzed) {
                            summaryText += `🔍 Muestra analizada: ${summary.sampleAnalyzed} de ${summary.totalIdsFound}\n`;
                        }
                        summaryText += `✅ Cargados exitosamente: ${summary.successfullyLoaded}\n`;
                        summaryText += `❌ Errores: ${summary.errorProducts}\n`;
                        summaryText += `🏷️ Con SKU: ${summary.withSKU}\n`;
                        summaryText += `🚫 Sin SKU: ${summary.withoutSKU}\n\n`;
                        
                        summaryText += `ESTADOS:\n`;
                        Object.entries(summary.byStatus).forEach(([status, count]) => {
                            summaryText += `- ${status}: ${count} productos\n`;
                        });
                        
                        summaryText += `\nTIPOS DE ENLACES:\n`;
                        Object.entries(summary.byLinkType).forEach(([type, count]) => {
                            summaryText += `- ${type}: ${count} productos\n`;
                        });
                        
                        if (data.errors && data.errors.length > 0) {
                            summaryText += `\n❌ PRODUCTOS CON ERRORES:\n`;
                            data.errors.forEach(error => {
                                summaryText += `- ${error.id}: ${error.error}\n`;
                            });
                        }
                        
                        alert(summaryText + '\n\nRevisa la consola para detalles completos.');
                        
                        // Buscar específicamente el DDJ-200 problemático
                        const ddj200Problem = data.productDetails.find(p => p.id === 'MLA1511790506');
                        if (ddj200Problem) {
                            console.warn('🎛️ PRODUCTO DDJ-200 PROBLEMÁTICO ENCONTRADO:', ddj200Problem);
                        } else {
                            console.warn('🎛️ PRODUCTO DDJ-200 (MLA1511790506) NO ENCONTRADO EN LA LISTA DE PRODUCTOS');
                            
                            // Buscar productos similares
                            const ddj200Similar = data.productDetails.filter(p => 
                                p.title && p.title.toLowerCase().includes('ddj')
                            );
                            if (ddj200Similar.length > 0) {
                                console.warn('🎛️ PRODUCTOS DDJ SIMILARES ENCONTRADOS:', ddj200Similar);
                            }
                        }
                        
                    })
                    .catch(error => {
                        console.error('❌ Error obteniendo todos los productos:', error);
                        alert('Error al obtener información de productos. Revisa la consola.');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            };
            
            // NUEVA: Función para sincronización completa con limpieza de cache
            window.forceSyncClean = function() {
                if (!confirm('¿Estás seguro? Esto limpiará todo el cache y volverá a cargar todos los productos desde cero.')) {
                    return;
                }
                
                console.log('🧹 Iniciando sincronización completa con limpieza...');
                
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Limpiando...';
                button.disabled = true;
                
                updateSyncStatus('syncing', 'Limpiando cache y sincronizando...');
                
                fetch('/debug/force-sync', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('✅ SINCRONIZACIÓN COMPLETA:', data);
                        
                        if (data.success) {
                            alert(`Sincronización completa exitosa!\n\nTotal productos: ${data.result.totalProducts}\nProductos con stock bajo: ${data.result.lowStockProducts}\n\nCache limpiado y datos actualizados.`);
                            
                            // Forzar actualización del dashboard
                            setTimeout(() => loadStatus(true), 1000);
                        } else {
                            alert('Error en la sincronización: ' + (data.message || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error en sincronización:', error);
                        alert('Error al sincronizar. Revisa la consola.');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            };
            
            // NUEVA: Función para eliminar un producto fantasma específico
            window.removePhantomProduct = function(productId) {
                if (!confirm(`¿Eliminar el producto fantasma ${productId} del cache?`)) {
                    return;
                }
                
                console.log(`🔍 Eliminando producto fantasma: ${productId}`);
                
                fetch(`/debug/remove-phantom-product/${productId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('✅ PRODUCTO FANTASMA ELIMINADO:', data);
                        
                        if (data.success) {
                            alert(`Producto fantasma ${productId} eliminado del cache.\n\nResultados:\n- Estaba en tracked: ${data.cleanupResults.wasInTracked}\n- Estaba en state: ${data.cleanupResults.wasInState}\n- Estaba en low stock: ${data.cleanupResults.wasInLowStock}`);
                            
                            // Actualizar dashboard
                            setTimeout(() => loadStatus(true), 500);
                        } else {
                            alert('Error eliminando producto fantasma: ' + (data.message || 'Error desconocido'));
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error eliminando producto fantasma:', error);
                        alert('Error al eliminar producto fantasma. Revisa la consola.');
                    });
            };
            
            // NUEVA: Función para continuar el scan de productos
            window.continueProductScan = function() {
                console.log('🔄 Continuando scan de productos...');
                
                // OPTIMIZADO: Pausar auto-refresh durante scan para evitar conflictos
                scanInProgress = true;
                clearInterval(autoRefreshInterval);
                console.log('⏸️ Auto-refresh pausado durante scan');
                
                const button = document.getElementById('continue-scan-btn');
                const buttonText = document.getElementById('continue-scan-text');
                const originalText = buttonText.innerHTML;
                
                buttonText.innerHTML = 'Obteniendo...';
                button.disabled = true;
                
                updateSyncStatus('syncing', 'Obteniendo más productos...');
                
                fetch('/api/products/continue-scan', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('✅ CONTINUACIÓN DE SCAN:', data);
                        
                        if (data.success) {
                            const result = data.scanResult;
                            const newProductsCount = result.newProducts || 0; // Solo productos nuevos
                            const totalProducts = result.total || 0; // Total acumulado
                            const scanCompleted = result.scanCompleted || false;
                            
                            // CORREGIDO: Mensaje diferente para scan completado vs productos nuevos
                            if (scanCompleted && newProductsCount === 0) {
                                alert(`🏁 Scan completado exitosamente!\n\n` +
                                      `No hay más productos disponibles\n` +
                                      `Total final: ${totalProducts} productos\n` +
                                      `Todos los productos están ahora monitoreados`);
                            } else {
                                alert(`¡Scan continuado exitosamente!\n\n` +
                                      `${newProductsCount} productos nuevos obtenidos\n` +
                                      `Total acumulado: ${totalProducts} productos\n` +
                                      `Scan completado: ${scanCompleted ? 'SÍ' : 'NO'}\n` +
                                      `Más productos disponibles: ${result.hasMoreProducts ? 'SÍ' : 'NO'}`);
                            }
                            
                            // MEJORADO: Actualización múltiple y forzada del dashboard
                            // 1. Actualización inmediata
                            loadStatus(true);
                            
                            // 2. Actualización con delay para asegurar sincronización del backend
                            setTimeout(() => {
                                console.log('🔄 Segunda actualización para sincronizar backend...');
                                loadStatus(true);
                            }, 1500);
                            
                            // 3. Actualización final para confirmar estado (especialmente importante si scan completado)
                            setTimeout(() => {
                                console.log('🔄 Actualización final para confirmar estado...');
                                loadStatus(true);
                                
                                // NUEVO: Verificar estado del botón cuando scan completado
                                if (scanCompleted && newProductsCount === 0) {
                                    console.log('🏁 Scan completado confirmado - verificando que botón esté oculto');
                                    const btn = document.getElementById('continue-scan-btn');
                                    if (btn && btn.style.display !== 'none') {
                                        console.warn('⚠️ Botón aún visible, forzando ocultación...');
                                        btn.style.display = 'none';
                                    }
                                }
                                
                                // Verificar contadores solo si hubo productos nuevos
                                if (newProductsCount > 0) {
                                    const currentTotal = document.getElementById('total-products').textContent;
                                    const currentLowStock = document.getElementById('low-stock-products').textContent;
                                    console.log(`📊 Contadores después del scan: Total=${currentTotal}, BajoStock=${currentLowStock}`);
                                    
                                    if (parseInt(currentTotal) < totalProducts) {
                                        console.warn('⚠️ Los contadores no se actualizaron completamente, forzando otra actualización...');
                                        setTimeout(() => loadStatus(true), 1000);
                                    }
                                }
                            }, 3000);
                            
                            // CORREGIDO: Mensaje de estado diferente para scan completado
                            const statusMessage = scanCompleted && newProductsCount === 0 
                                ? 'Scan completado - todos los productos monitoreados'
                                : `${newProductsCount} productos nuevos obtenidos (total: ${totalProducts})`;
                            updateSyncStatus('success', statusMessage);
                        } else {
                            alert('Error continuando scan: ' + (data.message || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error continuando scan:', error);
                        alert('Error al continuar scan. Revisa la consola.');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        buttonText.innerHTML = originalText;
                        button.disabled = false;
                        
                        // OPTIMIZADO: Reanudar auto-refresh después del scan
                        scanInProgress = false;
                        autoRefreshInterval = setInterval(loadStatus, 15000);
                        console.log('▶️ Auto-refresh reanudado después del scan');
                    });
            };
            
            // Hacer funciones disponibles globalmente
            window.loadCategoriesInfo = loadCategoriesInfo;
            
            // Hacer funciones de debug disponibles globalmente
            console.log('🐛 FUNCIONES DE DEBUG DISPONIBLES:');
            console.log('- debugProductDetails(productId): Debug de un producto específico');
            console.log('- debugSystem(): Debug completo del sistema');
            console.log('- debugAllProducts(): Ver TODOS los productos del usuario');
            console.log('- forceSyncClean(): Sincronización completa con limpieza');
            console.log('- removePhantomProduct(productId): Eliminar producto fantasma');
            console.log('- loadCategoriesInfo(): Cargar información de categorías desde la API');
            console.log('- Para usar: debugSystem() o debugProductDetails("MLA1234567890")');
        });
    </script>
</body>
</html>