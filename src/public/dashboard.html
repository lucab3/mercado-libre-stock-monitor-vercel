<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Monitor de Stock ML</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .nav-link {
            font-weight: 500;
            color: #333;
        }
        .nav-link.active {
            color: #007bff;
        }
        main {
            padding-top: 48px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-inactive {
            background-color: #dc3545;
        }
        .auto-refresh-info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .sync-indicator {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .sync-indicator.syncing {
            color: #007bff;
        }
        .sync-indicator.error {
            color: #dc3545;
        }
        .last-updated {
            font-size: 0.75rem;
            color: #6c757d;
            font-style: italic;
        }
        .product-stock-realtime {
            font-weight: bold;
            color: #ffffff !important;
        }
        .product-stock-realtime.low {
            color: #ffc107;
        }
        .product-stock-realtime.empty {
            color: #dc3545;
        }
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* NUEVO: Estilos para enlaces a ML */
        .product-id-link {
            color: #007bff;
            text-decoration: none;
            font-family: monospace;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .product-id-link:hover {
            color: #0056b3;
            text-decoration: underline;
            transform: scale(1.05);
        }
        
        .ml-link-btn {
            background: linear-gradient(45deg, #FFF159, #FFE01B);
            border: none;
            color: #2c3e50;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        .ml-link-btn:hover {
            background: linear-gradient(45deg, #FFE01B, #FFF159);
            color: #2c3e50;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(255, 225, 27, 0.3);
        }
        
        .product-actions {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .product-title-container {
            max-width: 300px;
        }
        
        .product-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .product-meta {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .filter-controls {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .filter-group .form-select {
            min-width: 150px;
        }
        
        .category-filters {
            max-width: 400px;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
            padding: 1rem;
        }
        
        .category-checkboxes {
            max-height: 300px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: white;
            border: 1px solid #e9ecef;
            transition: background-color 0.2s;
        }
        
        .category-item:hover {
            background-color: #e3f2fd;
        }
        
        .category-item.has-subcategories {
            border-left: 3px solid #007bff;
        }
        
        .category-checkbox {
            margin-right: 0.5rem;
        }
        
        .category-name {
            font-size: 0.85rem;
            flex-grow: 1;
        }
        
        .category-path {
            font-size: 0.75rem;
            color: #6c757d;
            margin-left: 0.5rem;
        }
        
        .subcategory-item {
            margin-left: 1rem;
            border-left: 2px solid #28a745;
            background-color: #f0f9ff;
        }
        
        @media (max-width: 768px) {
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .category-checkboxes {
                grid-template-columns: 1fr;
            }
            
            .category-filters {
                max-width: 100%;
            }
        }

        /* NUEVO: Estilos para campanita de notificaciones */
        .notification-bell {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .notification-bell .btn {
            position: relative;
            border: none;
            background: transparent;
            font-size: 1.2rem;
            color: #ffffff;
            padding: 0.5rem;
            transition: all 0.2s ease;
        }

        .notification-bell .btn:hover {
            color: #ffc107;
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 350px;
            max-width: 400px;
            display: none;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
            border-radius: 0.375rem 0.375rem 0 0;
        }

        .notification-header h6 {
            margin: 0;
            color: #495057;
            font-weight: 600;
        }

        .notification-body {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.critical {
            border-left: 4px solid #dc3545;
        }

        .notification-item.warning {
            border-left: 4px solid #fd7e14;
        }

        .notification-item.info {
            border-left: 4px solid #28a745;
        }

        .notification-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .notification-description {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .notification-time {
            font-size: 0.75rem;
            color: #adb5bd;
        }

        .notification-footer {
            padding: 0.75rem 1rem;
            border-top: 1px solid #dee2e6;
            background: #f8f9fa;
            text-align: center;
        }

        .notification-footer .btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
        }

        .alert-section {
            margin-bottom: 2rem;
        }

        .alert-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .alert-filter-btn {
            position: relative;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            background: white;
            color: #495057;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .alert-filter-btn:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }

        .alert-filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .alert-filter-btn.active.critical {
            background: #dc3545;
            border-color: #dc3545;
        }

        .alert-filter-btn.active.warning {
            background: #fd7e14;
            border-color: #fd7e14;
        }

        .alert-filter-btn.active.info {
            background: #28a745;
            border-color: #28a745;
        }

        .alert-filter-count {
            background: rgba(0, 0, 0, 0.1);
            color: inherit;
            border-radius: 0.75rem;
            padding: 0.125rem 0.375rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .alerts-table {
            margin-top: 1rem;
        }

        .alert-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .alert-row:hover {
            background-color: #f8f9fa;
        }

        .alert-row.critical {
            border-left: 4px solid #dc3545;
        }

        .alert-row.warning {
            border-left: 4px solid #fd7e14;
        }

        .alert-row.info {
            border-left: 4px solid #28a745;
        }

        .alert-priority-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
        }

        .alert-priority-badge.critical {
            background: #dc3545;
            color: white;
        }

        .alert-priority-badge.warning {
            background: #fd7e14;
            color: white;
        }

        .alert-priority-badge.info {
            background: #28a745;
            color: white;
        }

        .settings-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .settings-panel h6 {
            margin-bottom: 0.75rem;
            color: #495057;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .settings-row:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Monitor de Stock ML</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-nav flex-row">
            <div class="nav-item text-nowrap me-3">
                <button id="sync-btn" class="btn btn-sm btn-warning" onclick="startBackgroundSync()">
                    <i class="bi bi-arrow-clockwise"></i> <span id="sync-text">Sincronizar</span>
                </button>
            </div>
            <!-- NUEVA: Campanita de notificaciones -->
            <div class="nav-item text-nowrap me-3">
                <div class="notification-bell" onclick="toggleNotifications()">
                    <button class="btn">
                        <i class="bi bi-bell"></i>
                        <span id="notification-badge" class="notification-badge" style="display: none;">0</span>
                    </button>
                    <div id="notification-dropdown" class="notification-dropdown">
                        <div class="notification-header">
                            <h6>Alertas de Stock</h6>
                        </div>
                        <div id="notification-body" class="notification-body">
                            <div class="text-center p-3">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Cargando alertas...</span>
                                </div>
                                <div class="mt-2">Cargando alertas...</div>
                            </div>
                        </div>
                        <div class="notification-footer">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="viewAllAlerts()">
                                Ver todas
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleAlertSettings()">
                                <i class="bi bi-gear"></i> Configurar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-item text-nowrap me-3">
                <span class="navbar-text text-light">
                    <i class="bi bi-person-circle"></i> <span id="current-user">Cargando...</span>
                </span>
            </div>
            <div class="nav-item text-nowrap">
                <a href="/auth/logout" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </a>
            </div>
        </div>
    </header>
    
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="sidebar-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('alerts')">
                                <i class="bi bi-exclamation-triangle"></i> Alertas
                                <span id="sidebar-alert-count" class="badge bg-danger ms-2" style="display: none;">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('products')">
                                <i class="bi bi-box-seam"></i> Productos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('sessions')">
                                <i class="bi bi-people"></i> Sesiones Activas
                                <span id="active-sessions-count" class="badge bg-info ms-2">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('settings')">
                                <i class="bi bi-gear"></i> Configuración
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Indicador de sincronización -->
                    <div class="mt-3 px-3">
                        <small class="sync-indicator" id="sync-status">
                            <i class="bi bi-circle-fill"></i> Sincronizado
                        </small>
                        <div class="last-updated" id="last-sync-time">
                            Última actualización: Cargando...
                        </div>
                    </div>
                </div>
            </nav>
            
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- SECCIÓN DASHBOARD -->
                <div id="dashboard-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" id="start-monitoring" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-play-fill"></i> Iniciar monitoreo
                            </button>
                            <button type="button" id="stop-monitoring" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-stop-fill"></i> Detener monitoreo
                            </button>
                        </div>
                        <button type="button" id="refresh-status" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-repeat"></i> Actualizar estado
                        </button>
                        <button type="button" id="continue-scan-btn" onclick="continueProductScan()" class="btn btn-sm btn-success" title="Obtener siguientes productos" style="display: none;">
                            <i class="bi bi-plus-circle"></i> <span id="continue-scan-text">Obtener más productos</span>
                        </button>
                    </div>
                </div>

                <!-- Información sobre monitoreo dinámico -->
                <div class="auto-refresh-info">
                    <h6><i class="bi bi-info-circle"></i> Monitoreo en tiempo real</h6>
                    <p class="mb-1"><strong>API Real:</strong> Conectado a MercadoLibre con datos reales de tus publicaciones.</p>
                    <p class="mb-0"><strong>Controles:</strong> Usa "Verificar ahora" para actualizar datos o haz clic en cualquier ID/botón "ML" para ver la publicación real.</p>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Estado del monitoreo</h5>
                                <p class="card-text">
                                    <span id="monitoring-status">
                                        <span class="status-indicator status-inactive"></span>
                                        Inactivo
                                    </span>
                                </p>
                                <p class="card-text">Umbral de stock bajo: <span id="stock-threshold">5</span> unidades</p>
                                <p class="card-text">Intervalo de verificación: <span id="check-interval">15</span> minutos</p>
                                <p class="card-text">Última verificación: <span id="last-check">Nunca</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Resumen</h5>
                                <p class="card-text">Total de productos: <span id="total-products">0</span> <span id="scan-progress" class="badge bg-info" style="display: none;"></span></p>
                                <p class="card-text">Productos con stock bajo: <span id="low-stock-products">0</span></p>
                                <p class="card-text">Próxima verificación automática: <span id="next-auto-check">Al recargar la página</span></p>
                                <div id="scan-status" class="alert alert-info" style="display: none; margin-top: 10px; padding: 8px;">
                                    <small><i class="bi bi-info-circle"></i> <span id="scan-status-text"></span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Productos con stock bajo</h2>
                    <div class="filter-controls">
                        <div class="filter-group me-3">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <label class="form-label me-2 mb-0">Filtrar categorías:</label>
                                <button type="button" id="clear-categories" class="btn btn-sm btn-outline-secondary" title="Limpiar filtros de categorías">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </button>
                                <button type="button" id="toggle-categories" class="btn btn-sm btn-outline-info" title="Mostrar/Ocultar filtros">
                                    <i class="bi bi-funnel"></i> <span id="toggle-text">Mostrar</span>
                                </button>
                            </div>
                            <div id="category-filters" class="category-filters" style="display: none;">
                                <div id="category-loading" class="text-center p-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Cargando categorías...</span>
                                    </div>
                                    <div class="mt-2">Obteniendo categorías...</div>
                                </div>
                                <div id="category-checkboxes" class="category-checkboxes" style="display: none;">
                                    <!-- Se cargan dinámicamente -->
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="stock-filter" class="form-label me-2">Ordenar por stock:</label>
                            <select id="stock-filter" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                                <option value="default">Sin ordenar</option>
                                <option value="stock-asc">Menor a mayor stock</option>
                                <option value="stock-desc">Mayor a menor stock</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Producto</th>
                                <th>SKU</th>
                                <th>Stock</th>
                                <th>Estado</th>
                                <th>Fulfillment</th>
                                <th>Publicación</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="low-stock-table">
                            <tr>
                                <td colspan="7" class="text-center">Cargando información...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </div>
                
                <!-- NUEVA SECCIÓN: ALERTAS -->
                <div id="alerts-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">
                            <i class="bi bi-exclamation-triangle"></i> Alertas de Stock
                        </h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" id="refresh-alerts" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="bi bi-arrow-repeat"></i> Actualizar
                            </button>
                            <button type="button" id="cleanup-webhooks-btn" class="btn btn-sm btn-outline-warning me-2" onclick="cleanupWebhooks()">
                                <i class="bi bi-trash"></i> Limpiar webhooks
                            </button>
                            <button type="button" id="alert-settings-btn" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-gear"></i> Configurar alertas
                            </button>
                        </div>
                    </div>

                    <!-- Panel de configuración de alertas (oculto por defecto) -->
                    <div id="alert-settings-panel" class="settings-panel" style="display: none;">
                        <h6><i class="bi bi-gear"></i> Configuración de Alertas</h6>
                        <div class="settings-row">
                            <label for="enable-popups">Mostrar popups de alertas:</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enable-popups" checked>
                            </div>
                        </div>
                        <div class="settings-row">
                            <label for="enable-sound">Sonido de notificación:</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enable-sound">
                            </div>
                        </div>
                        <div class="settings-row">
                            <label for="critical-only">Solo alertas críticas:</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="critical-only">
                            </div>
                        </div>
                        <div class="settings-row">
                            <button class="btn btn-sm btn-success" onclick="saveAlertSettings()">
                                <i class="bi bi-check"></i> Guardar configuración
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleAlertSettings()">
                                Cancelar
                            </button>
                        </div>
                    </div>

                    <!-- Filtros de alertas -->
                    <div class="alert-filters">
                        <button class="alert-filter-btn active" data-filter="all" onclick="filterAlerts('all')">
                            <i class="bi bi-list"></i> Todas
                            <span class="alert-filter-count" id="count-all">0</span>
                        </button>
                        <button class="alert-filter-btn critical" data-filter="critical" onclick="filterAlerts('critical')">
                            <i class="bi bi-exclamation-triangle"></i> Críticas
                            <span class="alert-filter-count" id="count-critical">0</span>
                        </button>
                        <button class="alert-filter-btn warning" data-filter="warning" onclick="filterAlerts('warning')">
                            <i class="bi bi-exclamation-circle"></i> Advertencias
                            <span class="alert-filter-count" id="count-warning">0</span>
                        </button>
                        <button class="alert-filter-btn info" data-filter="info" onclick="filterAlerts('info')">
                            <i class="bi bi-info-circle"></i> Informativas
                            <span class="alert-filter-count" id="count-info">0</span>
                        </button>
                    </div>

                    <!-- Tabla de alertas -->
                    <div class="table-responsive alerts-table">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Producto</th>
                                    <th>SKU</th>
                                    <th>Stock Anterior</th>
                                    <th>Stock Actual</th>
                                    <th>Tiempo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="alerts-table">
                                <tr>
                                    <td colspan="7" class="text-center">Cargando alertas...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted">
                            <small id="alerts-pagination-info">Mostrando 0 de 0 alertas</small>
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm">
                                <li class="page-item" id="alerts-prev-page">
                                    <a class="page-link" href="#" onclick="loadAlerts('prev')">Anterior</a>
                                </li>
                                <li class="page-item" id="alerts-next-page">
                                    <a class="page-link" href="#" onclick="loadAlerts('next')">Siguiente</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
                
                <!-- SECCIÓN PRODUCTOS (placeholder) -->
                <div id="products-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">
                            <i class="bi bi-box-seam"></i> Productos
                        </h1>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Esta sección está en desarrollo.
                    </div>
                </div>
                
                <!-- SECCIÓN SESIONES ACTIVAS -->
                <div id="sessions-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">
                            <i class="bi bi-people"></i> Sesiones Activas
                        </h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshSessions()">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Estadísticas resumidas -->
                    <div class="row mb-4">
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-primary shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Total Sesiones
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-sessions-stat">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="bi bi-people fs-2 text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-success shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                Usuarios Únicos
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="unique-users-stat">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="bi bi-person-check fs-2 text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-info shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                IPs Únicas
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="unique-ips-stat">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="bi bi-router fs-2 text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-warning shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                Expirando Pronto
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="expiring-sessions-stat">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="bi bi-clock fs-2 text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabla de sesiones -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Detalle de Sesiones por Usuario</h6>
                        </div>
                        <div class="card-body">
                            <div id="sessions-loading" class="text-center p-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Cargando sesiones...</span>
                                </div>
                                <div class="mt-2">Cargando información de sesiones...</div>
                            </div>
                            
                            <div id="sessions-content" style="display: none;">
                                <div id="sessions-by-user"></div>
                            </div>
                            
                            <div id="sessions-error" style="display: none;" class="alert alert-danger">
                                <strong>Error:</strong> No se pudieron cargar las sesiones. 
                                <button class="btn btn-sm btn-outline-danger ms-2" onclick="refreshSessions()">Reintentar</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN CONFIGURACIÓN (placeholder) -->
                <div id="settings-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">
                            <i class="bi bi-gear"></i> Configuración
                        </h1>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Esta sección está en desarrollo.
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales para estado
        let lastKnownState = null;
        let isLoading = false;
        let originalProductsData = []; // Para mantener los datos originales sin filtrar
        let availableCategories = new Map(); // Para mapear category_id a información de categoría
        let categoriesCache = new Map(); // Cache de categorías obtenidas de la API
        let categoriesLoaded = false;
        
        // NUEVAS: Variables globales para alertas
        let alertsData = [];
        let alertsLoaded = false;
        let currentAlertFilter = 'all';
        let alertsPage = 0;
        let alertsPerPage = 20;
        let alertSettings = {
            popupsEnabled: true,
            soundEnabled: false,
            criticalOnly: false
        };
        let currentSection = 'dashboard'; // Sección actual del dashboard
        
        // Script para interactuar con la API - MEJORADO CON ENLACES A ML
        document.addEventListener('DOMContentLoaded', function() {
            // Comprobar estado inicial
            loadStatus();
            checkSessionStatus(); // Verificar sesión ML por separado
            loadAlertSettings(); // Cargar configuración de alertas
            
            // Auto-refresh desde BD cada 30 segundos (sin validaciones de sesión)
            let autoRefreshInterval = setInterval(loadStatus, 30000); // 30 segundos
            
            // Verificar sesión ML cada 2 minutos (menos frecuente)
            let sessionCheckInterval = setInterval(checkSessionStatus, 120000); // 2 minutos
            let scanInProgress = false;
            
            // Eventos de botones
            document.getElementById('start-monitoring').addEventListener('click', startMonitoring);
            document.getElementById('stop-monitoring').addEventListener('click', stopMonitoring);
            document.getElementById('refresh-status').addEventListener('click', () => loadStatus(true));
            document.getElementById('stock-filter').addEventListener('change', applyFilters);
            document.getElementById('toggle-categories').addEventListener('click', toggleCategoryFilters);
            document.getElementById('clear-categories').addEventListener('click', clearCategoryFilters);
            
            function updateSyncStatus(status, message = '') {
                const syncElement = document.getElementById('sync-status');
                const timeElement = document.getElementById('last-sync-time');
                
                syncElement.className = `sync-indicator ${status}`;
                
                switch(status) {
                    case 'syncing':
                        syncElement.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Sincronizando...';
                        break;
                    case 'error':
                        syncElement.innerHTML = '<i class="bi bi-exclamation-circle-fill"></i> Error de sincronización';
                        break;
                    default:
                        syncElement.innerHTML = '<i class="bi bi-check-circle-fill"></i> Sincronizado';
                }
                
                if (message) {
                    timeElement.textContent = message;
                } else {
                    timeElement.textContent = 'Última actualización: ' + new Date().toLocaleString();
                }
            }
            
            function updateUserInfo(userInfo) {
                const userElement = document.getElementById('current-user');
                
                if (userInfo) {
                    // Preferir nickname si está disponible, sino usar ID
                    let displayName = '';
                    
                    if (userInfo.nickname) {
                        displayName = userInfo.nickname;
                    } else if (userInfo.sessionInfo && userInfo.sessionInfo.userId) {
                        displayName = userInfo.sessionInfo.userId;
                    } else if (userInfo.id) {
                        displayName = userInfo.id;
                    } else {
                        displayName = 'Usuario desconocido';
                    }
                    
                    userElement.textContent = displayName;
                } else {
                    userElement.textContent = 'Usuario desconocido';
                }
            }
            
            function loadStatus(forceRefresh = false) {
                if (isLoading && !forceRefresh) return;
                
                isLoading = true;
                updateSyncStatus('syncing');
                
                // Usar nuevo endpoint que lee solo BD sin validar sesión
                fetch('/api/monitor/status-db')
                    .then(response => response.json())
                    .then(data => {
                        // Solo actualizar si hay datos de monitoreo
                        if (!data.monitoring) {
                            console.warn('⚠️ No hay datos de monitoreo disponibles');
                            return;
                        }
                        
                        // Verificar si los datos han cambiado
                        const dataChanged = !lastKnownState || 
                                          JSON.stringify(data.monitoring.lowStockProducts) !== 
                                          JSON.stringify(lastKnownState.lowStockProducts);
                        
                        if (dataChanged || forceRefresh) {
                            console.log('📊 Datos actualizados desde BD:', data.monitoring);
                            updateMonitoringStatus(data.monitoring);
                            updateProductTable(data.monitoring.lowStockProducts || []);
                            lastKnownState = data.monitoring;
                        }
                        
                        updateSyncStatus('synced');
                        isLoading = false;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        updateSyncStatus('error', 'Error al sincronizar datos');
                        
                        // Mostrar error en la tabla solo si no hay datos previos
                        if (!lastKnownState) {
                            const tableBody = document.getElementById('low-stock-table');
                            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar información. <button class="btn btn-sm btn-link" onclick="loadStatus(true)">Reintentar</button></td></tr>';
                        }
                        
                        isLoading = false;
                    });
            }
            
            // Función separada para verificar solo el estado de sesión ML
            function checkSessionStatus() {
                fetch('/api/auth/session-status')
                    .then(response => response.json())
                    .then(data => {
                        if (!data.authenticated) {
                            // Redirigir a login si no está autenticado
                            window.location.href = '/';
                            return;
                        }
                        
                        // Actualizar info del usuario si está disponible
                        if (data.user) {
                            updateUserInfo(data.user);
                        }
                    })
                    .catch(error => {
                        console.error('Error verificando sesión ML:', error);
                        // No hacer nada crítico aquí para no interrumpir la UI
                    });
            }
            
            function startMonitoring() {
                const button = document.getElementById('start-monitoring');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Iniciando...';
                button.disabled = true;
                
                updateSyncStatus('syncing', 'Iniciando monitoreo...');
                
                fetch('/api/monitor/start', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Monitoreo iniciado correctamente');
                            loadStatus(true); // Forzar actualización inmediata
                        } else {
                            alert('Error al iniciar el monitoreo: ' + (data.error || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al iniciar el monitoreo');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            }
            
            function stopMonitoring() {
                updateSyncStatus('syncing', 'Deteniendo monitoreo...');
                
                fetch('/api/monitor/stop', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Monitoreo detenido correctamente');
                            loadStatus(true);
                        } else {
                            alert('Error al detener el monitoreo: ' + (data.error || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al detener el monitoreo');
                        updateSyncStatus('error');
                    });
            }
            

            
            function updateMonitoringStatus(monitoring) {
                const statusElement = document.getElementById('monitoring-status');
                const indicator = statusElement.querySelector('.status-indicator');
                
                if (monitoring.active) {
                    indicator.classList.remove('status-inactive');
                    indicator.classList.add('status-active');
                    statusElement.innerHTML = indicator.outerHTML + ' Activo';
                } else {
                    indicator.classList.remove('status-active');
                    indicator.classList.add('status-inactive');
                    statusElement.innerHTML = indicator.outerHTML + ' Inactivo';
                }
                
                // MEJORADO: Actualizar elementos con validación de datos
                document.getElementById('stock-threshold').textContent = monitoring.threshold || '5';
                document.getElementById('check-interval').textContent = Math.floor((monitoring.checkInterval || 900000) / 60000);
                
                // CRÍTICO: Asegurar que totalProducts se actualice correctamente
                const totalProducts = monitoring.totalProducts || '0';
                const lowStockCount = (monitoring.lowStockProducts || []).length;
                
                const totalElement = document.getElementById('total-products');
                const lowStockElement = document.getElementById('low-stock-products');
                
                // Log para debugging de actualizaciones
                console.log(`📊 Actualizando contadores: Total=${totalProducts}, BajoStock=${lowStockCount}`);
                
                totalElement.textContent = totalProducts;
                lowStockElement.textContent = lowStockCount;
                
                // NUEVO: Forzar repintado del DOM para asegurar que se visualicen los cambios
                totalElement.style.fontWeight = 'bold';
                lowStockElement.style.fontWeight = 'bold';
                setTimeout(() => {
                    totalElement.style.fontWeight = 'normal';
                    lowStockElement.style.fontWeight = 'normal';
                }, 500);
                
                // Última verificación
                const lastCheck = monitoring.lastCheckTime;
                if (lastCheck) {
                    const date = new Date(lastCheck);
                    document.getElementById('last-check').textContent = date.toLocaleString();
                } else {
                    document.getElementById('last-check').textContent = 'Nunca';
                }
                
                // Próxima verificación automática
                if (monitoring.active) {
                    document.getElementById('next-auto-check').textContent = 'Al recargar la página o en 15 min';
                } else {
                    document.getElementById('next-auto-check').textContent = 'Monitoreo inactivo';
                }
                
                // NUEVO: Manejo del botón de continuación del scan
                updateScanControls(monitoring);
            }
            
            function updateScanControls(monitoring) {
                const continueBtn = document.getElementById('continue-scan-btn');
                const scanProgress = document.getElementById('scan-progress');
                const scanStatus = document.getElementById('scan-status');
                const scanStatusText = document.getElementById('scan-status-text');
                
                // Revisar si hay información del scan por lotes
                const scanInfo = monitoring.scanInfo || monitoring.batchInfo || monitoring;
                const totalProducts = monitoring.totalProducts || 0;
                
                console.log('🔍 updateScanControls - scanInfo:', scanInfo);
                console.log('🔍 updateScanControls - totalProducts:', totalProducts);
                
                if (scanInfo && (scanInfo.hasMore !== undefined || scanInfo.scanCompleted !== undefined)) {
                    // Mostrar información del scan por lotes
                    const hasMoreProducts = scanInfo.hasMoreProducts || scanInfo.hasMore;
                    const scanCompleted = scanInfo.scanCompleted;
                    
                    console.log(`🔍 Scan status: completed=${scanCompleted}, hasMore=${hasMoreProducts}, total=${totalProducts}`);
                    
                    if (hasMoreProducts && !scanCompleted) {
                        // Hay más productos disponibles - mostrar botón
                        continueBtn.style.display = 'inline-block';
                        scanProgress.style.display = 'inline';
                        scanProgress.textContent = `${totalProducts} productos cargados`;
                        scanProgress.className = 'badge bg-warning';
                        
                        scanStatus.style.display = 'block';
                        scanStatusText.textContent = `Tienes ${totalProducts} productos cargados. Cada click obtiene más productos. Haz clic en "Obtener más productos" para continuar.`;
                        scanStatus.className = 'alert alert-warning';
                        
                        console.log('✅ Mostrando botón de continuar scan');
                    } else if (scanCompleted || (!hasMoreProducts && totalProducts > 0)) {
                        // Scan completado - ocultar botón y mostrar estado final
                        continueBtn.style.display = 'none';
                        scanProgress.style.display = 'inline';
                        scanProgress.textContent = 'Todos los productos obtenidos';
                        scanProgress.className = 'badge bg-success';
                        
                        scanStatus.style.display = 'block';
                        scanStatusText.textContent = `✅ Scan completo: ${totalProducts} productos cargados. No hay más productos disponibles.`;
                        scanStatus.className = 'alert alert-success';
                        
                        console.log('✅ Scan completado - ocultando botón de continuar');
                    } else {
                        // Estado intermedio - probablemente primer scan
                        if (totalProducts > 0) {
                            // Mostrar información básica pero sin botón hasta confirmar estado
                            continueBtn.style.display = 'none';
                            scanProgress.style.display = 'inline';
                            scanProgress.textContent = `${totalProducts} productos`;
                            scanProgress.className = 'badge bg-info';
                            
                            scanStatus.style.display = 'block';
                            scanStatusText.textContent = `${totalProducts} productos cargados. Verificando si hay más disponibles...`;
                            scanStatus.className = 'alert alert-info';
                        } else {
                            // Sin productos aún
                            continueBtn.style.display = 'none';
                            scanProgress.style.display = 'none';
                            scanStatus.style.display = 'none';
                        }
                        
                        console.log('ℹ️ Estado intermedio de scan');
                    }
                } else {
                    // Sin información de scan - posiblemente primer carga
                    if (totalProducts > 0) {
                        // Hay productos pero sin info de scan, mostrar info básica
                        continueBtn.style.display = 'none';
                        scanProgress.style.display = 'inline';
                        scanProgress.textContent = `${totalProducts} productos`;
                        scanProgress.className = 'badge bg-secondary';
                        
                        scanStatus.style.display = 'none';
                        console.log('ℹ️ Productos encontrados sin info de scan');
                    } else {
                        // Sin información de scan ni productos - ocultar controles
                        continueBtn.style.display = 'none';
                        scanProgress.style.display = 'none';
                        scanStatus.style.display = 'none';
                        console.log('ℹ️ Sin información de scan - ocultando controles');
                    }
                }
            }
            
            function applyFilters() {
                let filteredProducts = [...originalProductsData];
                
                // 1. Aplicar filtro de categorías primero
                const selectedCheckboxes = document.querySelectorAll('#category-checkboxes .category-checkbox:checked');
                const selectedCategories = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
                
                if (selectedCategories.length > 0) {
                    filteredProducts = filteredProducts.filter(product => 
                        selectedCategories.includes(product.category_id)
                    );
                }
                
                // 2. Aplicar ordenamiento por stock
                const stockFilterValue = document.getElementById('stock-filter').value;
                
                switch(stockFilterValue) {
                    case 'stock-asc':
                        filteredProducts.sort((a, b) => a.stock - b.stock);
                        break;
                    case 'stock-desc':
                        filteredProducts.sort((a, b) => b.stock - a.stock);
                        break;
                    case 'default':
                    default:
                        // Mantener orden original (después del filtro de categorías)
                        break;
                }
                
                renderProductTable(filteredProducts);
                
                // Actualizar contador de productos filtrados
                updateFilteredCount(filteredProducts.length, originalProductsData.length);
            }
            
            function clearCategoryFilters() {
                const checkboxes = document.querySelectorAll('#category-checkboxes .category-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                applyFilters(); // Reaplicar filtros
            }
            
            function toggleCategoryFilters() {
                const categoryFilters = document.getElementById('category-filters');
                const toggleText = document.getElementById('toggle-text');
                const isVisible = categoryFilters.style.display !== 'none';
                
                if (isVisible) {
                    categoryFilters.style.display = 'none';
                    toggleText.textContent = 'Mostrar';
                } else {
                    categoryFilters.style.display = 'block';
                    toggleText.textContent = 'Ocultar';
                    
                    // Solo cargar categorías la primera vez que se muestran
                    if (!categoriesLoaded) {
                        loadCategoriesInfo();
                    }
                }
            }
            
            function updateAvailableCategories(products) {
                // Limpiar categorías previas
                availableCategories.clear();
                
                // Extraer categorías únicas de los productos
                products.forEach(product => {
                    if (product.category_id) {
                        // Solo agregar si no está ya en la cache
                        if (!categoriesCache.has(product.category_id)) {
                            availableCategories.set(product.category_id, getCategoryDisplayName(product.category_id));
                        } else {
                            // Usar información de la cache si está disponible
                            const cachedCategory = categoriesCache.get(product.category_id);
                            availableCategories.set(product.category_id, cachedCategory.name);
                        }
                    }
                });
                
                // Si las categorías están visibles y cargadas, actualizar la interfaz
                if (categoriesLoaded && document.getElementById('category-filters').style.display !== 'none') {
                    updateCategorySelector();
                }
            }
            
            async function loadCategoriesInfo() {
                const categoryLoading = document.getElementById('category-loading');
                const categoryCheckboxes = document.getElementById('category-checkboxes');
                
                categoryLoading.style.display = 'block';
                categoryCheckboxes.style.display = 'none';
                
                try {
                    // Obtener categorías únicas de los productos actuales
                    const uniqueCategoryIds = [...new Set(originalProductsData
                        .map(product => product.category_id)
                        .filter(id => id)
                    )];
                    
                    if (uniqueCategoryIds.length === 0) {
                        categoryLoading.innerHTML = '<div class="text-center p-3"><i class="bi bi-info-circle"></i><div class="mt-2">No hay categorías para mostrar</div></div>';
                        return;
                    }
                    
                    // Filtrar categorías que no están en cache
                    const categoriesToFetch = uniqueCategoryIds.filter(id => !categoriesCache.has(id));
                    
                    if (categoriesToFetch.length > 0) {
                        console.log(`🔍 Obteniendo información de ${categoriesToFetch.length} categorías desde la API...`);
                        
                        const response = await fetch('/api/categories/info', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ categoryIds: categoriesToFetch })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Error HTTP: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.success && data.categories) {
                            // Guardar en cache
                            data.categories.forEach(category => {
                                categoriesCache.set(category.id, {
                                    id: category.id,
                                    name: category.name,
                                    path_from_root: category.path_from_root || [],
                                    children_categories: category.children_categories || []
                                });
                            });
                            
                            console.log(`✅ Información de ${data.categories.length} categorías guardada en cache`);
                        } else {
                            throw new Error(data.message || 'Error en la respuesta del servidor');
                        }
                    } else {
                        console.log('📋 Todas las categorías ya están en cache');
                    }
                    
                    // Actualizar availableCategories con información de la cache
                    uniqueCategoryIds.forEach(categoryId => {
                        const cachedCategory = categoriesCache.get(categoryId);
                        if (cachedCategory) {
                            availableCategories.set(categoryId, cachedCategory.name);
                        } else {
                            availableCategories.set(categoryId, getCategoryDisplayName(categoryId));
                        }
                    });
                    
                    categoriesLoaded = true;
                    categoryLoading.style.display = 'none';
                    categoryCheckboxes.style.display = 'block';
                    
                    // Actualizar la interfaz de checkboxes
                    updateCategorySelector();
                    
                } catch (error) {
                    console.error('❌ Error cargando información de categorías:', error);
                    categoryLoading.innerHTML = `
                        <div class="text-center p-3 text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            <div class="mt-2">Error cargando categorías</div>
                            <small>${error.message}</small>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadCategoriesInfo()">Reintentar</button>
                        </div>
                    `;
                }
            }
            
            function getCategoryDisplayName(categoryId) {
                // Mapeo básico de algunos category_ids conocidos a nombres amigables (fallback)
                const categoryNames = {
                    'MLM1055': 'Celulares y Teléfonos',
                    'MLM1648': 'Computación', 
                    'MLM1144': 'Consolas y Videojuegos',
                    'MLM1000': 'Electrónicos',
                    'MLM1403': 'Instrumentos Musicales',
                    'MLM1276': 'Deportes y Fitness',
                    'MLM1430': 'Ropa y Accesorios',
                    'MLM1132': 'Juegos y Juguetes',
                    'MLM1367': 'Industrias y Oficinas',
                    'MLM1039': 'Cámaras y Accesorios'
                };
                
                return categoryNames[categoryId] || `Categoría ${categoryId}`;
            }
            
            function updateCategorySelector() {
                const categoryCheckboxes = document.getElementById('category-checkboxes');
                const currentSelection = Array.from(document.querySelectorAll('#category-checkboxes .category-checkbox:checked'))
                    .map(checkbox => checkbox.value);
                
                // Limpiar checkboxes actuales
                categoryCheckboxes.innerHTML = '';
                
                // Agregar categorías disponibles ordenadas
                const sortedCategories = Array.from(availableCategories.entries())
                    .sort((a, b) => a[1].localeCompare(b[1])); // Ordenar por nombre
                
                sortedCategories.forEach(([categoryId, categoryName]) => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item';
                    
                    // Verificar si tiene subcategorías
                    const cachedCategory = categoriesCache.get(categoryId);
                    const hasSubcategories = cachedCategory && cachedCategory.children_categories && 
                                            cachedCategory.children_categories.length > 0;
                    
                    if (hasSubcategories) {
                        categoryItem.classList.add('has-subcategories');
                    }
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'category-checkbox';
                    checkbox.value = categoryId;
                    checkbox.addEventListener('change', applyFilters);
                    
                    // Mantener selección previa si existe
                    if (currentSelection.includes(categoryId)) {
                        checkbox.checked = true;
                    }
                    
                    const label = document.createElement('label');
                    label.className = 'category-name';
                    label.textContent = categoryName;
                    label.addEventListener('click', () => {
                        checkbox.checked = !checkbox.checked;
                        applyFilters();
                    });
                    
                    // Mostrar path si está disponible
                    if (cachedCategory && cachedCategory.path_from_root && cachedCategory.path_from_root.length > 1) {
                        const pathSpan = document.createElement('span');
                        pathSpan.className = 'category-path';
                        const pathNames = cachedCategory.path_from_root.map(cat => cat.name).join(' > ');
                        pathSpan.textContent = pathNames;
                        categoryItem.appendChild(checkbox);
                        categoryItem.appendChild(label);
                        categoryItem.appendChild(pathSpan);
                    } else {
                        categoryItem.appendChild(checkbox);
                        categoryItem.appendChild(label);
                    }
                    
                    categoryCheckboxes.appendChild(categoryItem);
                    
                    // Agregar subcategorías si existen
                    if (hasSubcategories) {
                        cachedCategory.children_categories.forEach(subcat => {
                            const subcategoryItem = document.createElement('div');
                            subcategoryItem.className = 'category-item subcategory-item';
                            
                            const subCheckbox = document.createElement('input');
                            subCheckbox.type = 'checkbox';
                            subCheckbox.className = 'category-checkbox';
                            subCheckbox.value = subcat.id;
                            subCheckbox.addEventListener('change', applyFilters);
                            
                            if (currentSelection.includes(subcat.id)) {
                                subCheckbox.checked = true;
                            }
                            
                            const subLabel = document.createElement('label');
                            subLabel.className = 'category-name';
                            subLabel.textContent = `↳ ${subcat.name}`;
                            subLabel.addEventListener('click', () => {
                                subCheckbox.checked = !subCheckbox.checked;
                                applyFilters();
                            });
                            
                            subcategoryItem.appendChild(subCheckbox);
                            subcategoryItem.appendChild(subLabel);
                            categoryCheckboxes.appendChild(subcategoryItem);
                        });
                    }
                });
            }
            
            function updateFilteredCount(filtered, total) {
                // Actualizar el texto del header para mostrar filtros aplicados
                const header = document.querySelector('h2');
                if (filtered === total) {
                    header.textContent = 'Productos con stock bajo';
                } else {
                    header.textContent = `Productos con stock bajo (${filtered} de ${total} mostrados)`;
                }
            }
            
            function updateProductTable(lowStockProducts) {
                // Guardar datos originales
                originalProductsData = lowStockProducts || [];
                
                // Actualizar categorías disponibles
                updateAvailableCategories(originalProductsData);
                
                // Aplicar filtros actuales
                applyFilters();
            }
            
            function renderProductTable(lowStockProducts) {
                const tableBody = document.getElementById('low-stock-table');
                
                if (!lowStockProducts || lowStockProducts.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-success">¡Excelente! No hay productos con stock bajo.</td></tr>';
                    return;
                }
                
                console.log('📦 Actualizando tabla con productos:', lowStockProducts);
                
                tableBody.innerHTML = lowStockProducts.map(product => {
                    const stockClass = product.stock === 0 ? 'empty' : (product.stock <= 2 ? 'low' : '');
                    const statusClass = product.stock === 0 ? 'bg-danger' : 'bg-warning';
                    const statusText = product.stock === 0 ? 'Sin stock' : 'Stock bajo';
                    const trendIcon = product.stock === 0 ? '🔴' : product.stock <= 2 ? '⚠️' : '📦';
                    
                    // CORREGIDO: Usar productUrl validado del backend que incluye permalink real
                    const mlLink = product.productUrl || product.permalink || `https://articulo.mercadolibre.com.ar/${product.id}`;
                    
                    // NUEVO: Analizar tipo de enlace y estado de publicación
                    const linkType = product.permalink ? 
                        (product.permalink.includes('internal-shop.mercadoshops.com.ar') ? 'mercadoshops' : 'standard') : 
                        'generated';
                    const linkIcon = linkType === 'mercadoshops' ? '🏪' : (linkType === 'standard' ? '🔗' : '⚙️');
                    
                    // Estado de publicación
                    const pubStatus = product.status || 'unknown';
                    const pubStatusClass = pubStatus === 'active' ? 'bg-success' : 
                                          pubStatus === 'paused' ? 'bg-warning' : 'bg-danger';
                    const pubStatusText = pubStatus === 'active' ? 'Activa' : 
                                         pubStatus === 'paused' ? 'Pausada' : 
                                         pubStatus === 'closed' ? 'Cerrada' : 'Desconocido';
                    
                    // Debug de enlaces para verificar que están correctos
                    console.log(`🔗 Producto ${product.id}: URL = ${mlLink}, Tipo: ${linkType}, Estado: ${pubStatus}`);
                    if (product.permalink && product.productUrl && product.permalink !== product.productUrl) {
                        console.warn(`⚠️ Diferencia en enlaces para ${product.id}:`, {
                            permalink: product.permalink,
                            productUrl: product.productUrl
                        });
                    }
                    
                    return `
                        <tr>
                            <td>
                                <a href="${mlLink}" 
                                   target="_blank" 
                                   class="product-id-link" 
                                   title="Ver publicación en MercadoLibre">
                                    ${product.id}
                                    <i class="bi bi-box-arrow-up-right" style="font-size: 0.7rem;"></i>
                                </a>
                                <div class="product-meta" style="font-size: 0.6rem; color: #888;">
                                    ${linkIcon} ${linkType === 'mercadoshops' ? 'MercadoShops' : linkType === 'standard' ? 'ML Estándar' : 'Generado'}
                                    <button class="btn btn-xs btn-outline-secondary" onclick="debugProductDetails('${product.id}')" style="font-size: 0.5rem; padding: 1px 3px; margin-left: 5px;" title="Debug detalles">
                                        <i class="bi bi-bug"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="product-title-container">
                                <div class="product-title">${trendIcon} ${product.title}</div>
                                <div class="product-meta">Actualizado: ${new Date().toLocaleTimeString()}</div>
                            </td>
                            <td>
                                <span class="badge ${product.seller_sku ? 'bg-info' : 'bg-secondary'}" style="font-size: 0.75rem;">
                                    ${product.seller_sku || 'Sin SKU'}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${statusClass}">
                                    <span class="product-stock-realtime">${product.stock} unidades</span>
                                </span>
                            </td>
                            <td>
                                <span class="badge ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${product.is_fulfillment ? 'bg-primary' : 'bg-light text-dark'}" style="font-size: 0.75rem;">
                                    ${product.is_fulfillment ? '🚚 Full' : '📦 Normal'}
                                </span>
                                ${product.inventory_id ? `<div style="font-size: 0.6rem; color: #666;">ID: ${product.inventory_id}</div>` : ''}
                            </td>
                            <td>
                                <span class="badge ${pubStatusClass}" style="font-size: 0.75rem;">
                                    ${pubStatusText}
                                </span>
                                ${linkType === 'mercadoshops' ? '<div style="font-size: 0.6rem; color: #ff6b00;">🏪 MercadoShops</div>' : ''}
                            </td>
                            <td>
                                <div class="product-actions">
                                    <button class="btn btn-sm btn-outline-primary" onclick="checkProduct('${product.id}')" title="Verificar stock actual">
                                        <i class="bi bi-search"></i> Verificar
                                    </button>
                                    <a href="${mlLink}" 
                                       target="_blank" 
                                       class="btn btn-sm ml-link-btn" 
                                       title="Ver en MercadoLibre">
                                        <i class="bi bi-shop"></i> ML
                                    </a>
                                    <button class="btn btn-sm btn-outline-info" onclick="debugProduct('${product.id}')" title="Ver datos de debug">
                                        <i class="bi bi-bug"></i> Debug
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Función global para verificar producto específico - MEJORADA CON ENLACES
            window.checkProduct = function(productId) {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                button.disabled = true;
                
                updateSyncStatus('syncing', `Verificando producto ${productId}...`);
                
                fetch(`/api/products/${productId}/stock`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                            updateSyncStatus('error');
                        } else {
                            const stockStatus = data.available_quantity === 0 ? 'Sin stock' : 
                                              data.has_low_stock ? 'Stock bajo' : 'Stock suficiente';
                            
                            // NUEVO: Incluir enlace y SKU en el alert
                            const mlLink = data.productUrl || data.permalink || `https://articulo.mercadolibre.com.ar/${data.id}`;
                            const skuInfo = data.seller_sku ? `\nSKU: ${data.seller_sku}` : '\nSKU: Sin SKU';
                            
                            alert(`Producto: ${data.title}${skuInfo}\nStock actual: ${data.available_quantity} unidades\nEstado: ${stockStatus}\nÚltima actualización: ${new Date(data.last_updated).toLocaleString()}\n\n🔗 Ver en ML: ${mlLink}`);
                            
                            // Recargar estado después de verificación individual
                            setTimeout(() => loadStatus(true), 500);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al verificar el producto');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            };
            
            // NUEVA: Función global para debuggear detalles específicos de un producto
            window.debugProductDetails = function(productId) {
                console.log('🐛 DEBUGGING DETALLES DE PRODUCTO:', productId);
                
                // Buscar el producto en los datos actuales
                const product = lastKnownState?.lowStockProducts?.find(p => p.id === productId);
                if (product) {
                    console.log('📦 DATOS DEL PRODUCTO EN DASHBOARD:', {
                        id: product.id,
                        title: product.title,
                        stock: product.stock,
                        seller_sku: product.seller_sku,
                        permalink: product.permalink,
                        productUrl: product.productUrl,
                        linksMatch: product.permalink === product.productUrl
                    });
                    
                    // Mostrar alert con información de debug
                    const skuInfo = product.seller_sku ? `\nSKU: ${product.seller_sku}` : '\nSKU: Sin SKU';
                    const linkInfo = `\nPermalink: ${product.permalink || 'No disponible'}\nProductURL: ${product.productUrl || 'No disponible'}`;
                    const matchInfo = product.permalink && product.productUrl ? `\nEnlaces coinciden: ${product.permalink === product.productUrl ? 'SÍ' : 'NO'}` : '';
                    
                    alert(`DEBUG PRODUCTO ${productId}:\n\nTítulo: ${product.title}${skuInfo}\nStock: ${product.stock}${linkInfo}${matchInfo}`);
                } else {
                    alert(`No se encontraron datos para el producto ${productId} en el estado actual del dashboard`);
                }
            };
            
            // NUEVA: Función global para debug completo del sistema
            window.debugSystem = function() {
                console.log('🔧 DEBUGGING COMPLETO DEL SISTEMA:');
                console.log('Estado actual:', lastKnownState);
                console.log('Productos con stock bajo:', lastKnownState?.lowStockProducts);
                
                if (lastKnownState?.lowStockProducts) {
                    lastKnownState.lowStockProducts.forEach(product => {
                        console.log(`📦 ${product.id}:`, {
                            title: product.title,
                            stock: product.stock,
                            seller_sku: product.seller_sku,
                            permalink: product.permalink,
                            productUrl: product.productUrl,
                            linksMatch: product.permalink === product.productUrl
                        });
                    });
                }
                
                alert('Debug completo enviado a la consola del navegador. Abre Developer Tools > Console para ver los detalles.');
            };
            
            // NUEVA: Función para debuggear todos los productos
            window.debugAllProducts = function() {
                console.log('🔍 Obteniendo información de TODOS los productos...');
                
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Cargando...';
                button.disabled = true;
                
                fetch('/debug/all-products')
                    .then(response => response.json())
                    .then(data => {
                        console.log('📊 INFORMACIÓN COMPLETA DE PRODUCTOS:', data);
                        
                        // Mostrar resumen
                        const summary = data.summary;
                        let summaryText = `RESUMEN DE PRODUCTOS ${summary.scanMethod ? '(MÉTODO SCAN)' : ''}:\n\n`;
                        summaryText += `📋 Total de IDs encontrados: ${summary.totalIdsFound}\n`;
                        if (summary.sampleAnalyzed) {
                            summaryText += `🔍 Muestra analizada: ${summary.sampleAnalyzed} de ${summary.totalIdsFound}\n`;
                        }
                        summaryText += `✅ Cargados exitosamente: ${summary.successfullyLoaded}\n`;
                        summaryText += `❌ Errores: ${summary.errorProducts}\n`;
                        summaryText += `🏷️ Con SKU: ${summary.withSKU}\n`;
                        summaryText += `🚫 Sin SKU: ${summary.withoutSKU}\n\n`;
                        
                        summaryText += `ESTADOS:\n`;
                        Object.entries(summary.byStatus).forEach(([status, count]) => {
                            summaryText += `- ${status}: ${count} productos\n`;
                        });
                        
                        summaryText += `\nTIPOS DE ENLACES:\n`;
                        Object.entries(summary.byLinkType).forEach(([type, count]) => {
                            summaryText += `- ${type}: ${count} productos\n`;
                        });
                        
                        if (data.errors && data.errors.length > 0) {
                            summaryText += `\n❌ PRODUCTOS CON ERRORES:\n`;
                            data.errors.forEach(error => {
                                summaryText += `- ${error.id}: ${error.error}\n`;
                            });
                        }
                        
                        alert(summaryText + '\n\nRevisa la consola para detalles completos.');
                        
                        // Buscar específicamente el DDJ-200 problemático
                        const ddj200Problem = data.productDetails.find(p => p.id === 'MLA1511790506');
                        if (ddj200Problem) {
                            console.warn('🎛️ PRODUCTO DDJ-200 PROBLEMÁTICO ENCONTRADO:', ddj200Problem);
                        } else {
                            console.warn('🎛️ PRODUCTO DDJ-200 (MLA1511790506) NO ENCONTRADO EN LA LISTA DE PRODUCTOS');
                            
                            // Buscar productos similares
                            const ddj200Similar = data.productDetails.filter(p => 
                                p.title && p.title.toLowerCase().includes('ddj')
                            );
                            if (ddj200Similar.length > 0) {
                                console.warn('🎛️ PRODUCTOS DDJ SIMILARES ENCONTRADOS:', ddj200Similar);
                            }
                        }
                        
                    })
                    .catch(error => {
                        console.error('❌ Error obteniendo todos los productos:', error);
                        alert('Error al obtener información de productos. Revisa la consola.');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            };
            
            // NUEVA: Función para sincronización completa con limpieza de cache
            window.forceSyncClean = function() {
                if (!confirm('¿Estás seguro? Esto limpiará todo el cache y volverá a cargar todos los productos desde cero.')) {
                    return;
                }
                
                console.log('🧹 Iniciando sincronización completa con limpieza...');
                
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Limpiando...';
                button.disabled = true;
                
                updateSyncStatus('syncing', 'Limpiando cache y sincronizando...');
                
                fetch('/debug/force-sync', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('✅ SINCRONIZACIÓN COMPLETA:', data);
                        
                        if (data.success) {
                            alert(`Sincronización completa exitosa!\n\nTotal productos: ${data.result.totalProducts}\nProductos con stock bajo: ${data.result.lowStockProducts}\n\nCache limpiado y datos actualizados.`);
                            
                            // Forzar actualización del dashboard
                            setTimeout(() => loadStatus(true), 1000);
                        } else {
                            alert('Error en la sincronización: ' + (data.message || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error en sincronización:', error);
                        alert('Error al sincronizar. Revisa la consola.');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            };
            
            // NUEVA: Función para eliminar un producto fantasma específico
            window.removePhantomProduct = function(productId) {
                if (!confirm(`¿Eliminar el producto fantasma ${productId} del cache?`)) {
                    return;
                }
                
                console.log(`🔍 Eliminando producto fantasma: ${productId}`);
                
                fetch(`/debug/remove-phantom-product/${productId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('✅ PRODUCTO FANTASMA ELIMINADO:', data);
                        
                        if (data.success) {
                            alert(`Producto fantasma ${productId} eliminado del cache.\n\nResultados:\n- Estaba en tracked: ${data.cleanupResults.wasInTracked}\n- Estaba en state: ${data.cleanupResults.wasInState}\n- Estaba en low stock: ${data.cleanupResults.wasInLowStock}`);
                            
                            // Actualizar dashboard
                            setTimeout(() => loadStatus(true), 500);
                        } else {
                            alert('Error eliminando producto fantasma: ' + (data.message || 'Error desconocido'));
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error eliminando producto fantasma:', error);
                        alert('Error al eliminar producto fantasma. Revisa la consola.');
                    });
            };
            
            // NUEVA: Función para continuar el scan de productos
            window.continueProductScan = function() {
                console.log('🔄 Continuando scan de productos...');
                
                // OPTIMIZADO: Pausar auto-refresh durante scan para evitar conflictos
                scanInProgress = true;
                clearInterval(autoRefreshInterval);
                console.log('⏸️ Auto-refresh pausado durante scan');
                
                const button = document.getElementById('continue-scan-btn');
                const buttonText = document.getElementById('continue-scan-text');
                const originalText = buttonText.innerHTML;
                
                buttonText.innerHTML = 'Obteniendo...';
                button.disabled = true;
                
                updateSyncStatus('syncing', 'Obteniendo más productos...');
                
                fetch('/api/products/continue-scan', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('✅ CONTINUACIÓN DE SCAN:', data);
                        
                        if (data.success) {
                            const result = data.scanResult;
                            const newProductsCount = result.newProducts || 0; // Solo productos nuevos
                            const totalProducts = result.total || 0; // Total acumulado
                            const scanCompleted = result.scanCompleted || false;
                            
                            // CORREGIDO: Mensaje diferente para scan completado vs productos nuevos
                            if (scanCompleted && newProductsCount === 0) {
                                alert(`🏁 Scan completado exitosamente!\n\n` +
                                      `No hay más productos disponibles\n` +
                                      `Total final: ${totalProducts} productos\n` +
                                      `Todos los productos están ahora monitoreados`);
                            } else {
                                alert(`¡Scan continuado exitosamente!\n\n` +
                                      `${newProductsCount} productos nuevos obtenidos\n` +
                                      `Total acumulado: ${totalProducts} productos\n` +
                                      `Scan completado: ${scanCompleted ? 'SÍ' : 'NO'}\n` +
                                      `Más productos disponibles: ${result.hasMoreProducts ? 'SÍ' : 'NO'}`);
                            }
                            
                            // MEJORADO: Actualización múltiple y forzada del dashboard
                            // 1. Actualización inmediata
                            loadStatus(true);
                            
                            // 2. Actualización con delay para asegurar sincronización del backend
                            setTimeout(() => {
                                console.log('🔄 Segunda actualización para sincronizar backend...');
                                loadStatus(true);
                            }, 1500);
                            
                            // 3. Actualización final para confirmar estado (especialmente importante si scan completado)
                            setTimeout(() => {
                                console.log('🔄 Actualización final para confirmar estado...');
                                loadStatus(true);
                                
                                // NUEVO: Verificar estado del botón cuando scan completado
                                if (scanCompleted && newProductsCount === 0) {
                                    console.log('🏁 Scan completado confirmado - verificando que botón esté oculto');
                                    const btn = document.getElementById('continue-scan-btn');
                                    if (btn && btn.style.display !== 'none') {
                                        console.warn('⚠️ Botón aún visible, forzando ocultación...');
                                        btn.style.display = 'none';
                                    }
                                }
                                
                                // Verificar contadores solo si hubo productos nuevos
                                if (newProductsCount > 0) {
                                    const currentTotal = document.getElementById('total-products').textContent;
                                    const currentLowStock = document.getElementById('low-stock-products').textContent;
                                    console.log(`📊 Contadores después del scan: Total=${currentTotal}, BajoStock=${currentLowStock}`);
                                    
                                    if (parseInt(currentTotal) < totalProducts) {
                                        console.warn('⚠️ Los contadores no se actualizaron completamente, forzando otra actualización...');
                                        setTimeout(() => loadStatus(true), 1000);
                                    }
                                }
                            }, 3000);
                            
                            // CORREGIDO: Mensaje de estado diferente para scan completado
                            const statusMessage = scanCompleted && newProductsCount === 0 
                                ? 'Scan completado - todos los productos monitoreados'
                                : `${newProductsCount} productos nuevos obtenidos (total: ${totalProducts})`;
                            updateSyncStatus('success', statusMessage);
                        } else {
                            alert('Error continuando scan: ' + (data.message || 'Error desconocido'));
                            updateSyncStatus('error');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error continuando scan:', error);
                        alert('Error al continuar scan. Revisa la consola.');
                        updateSyncStatus('error');
                    })
                    .finally(() => {
                        buttonText.innerHTML = originalText;
                        button.disabled = false;
                        
                        // OPTIMIZADO: Reanudar auto-refresh después del scan
                        scanInProgress = false;
                        autoRefreshInterval = setInterval(loadStatus, 15000);
                        console.log('▶️ Auto-refresh reanudado después del scan');
                    });
            };
            
            // Hacer funciones disponibles globalmente
            window.loadCategoriesInfo = loadCategoriesInfo;
            
            // Hacer funciones de debug disponibles globalmente
            console.log('🐛 FUNCIONES DE DEBUG DISPONIBLES:');
            console.log('- debugProductDetails(productId): Debug de un producto específico');
            console.log('- debugSystem(): Debug completo del sistema');
            console.log('- debugAllProducts(): Ver TODOS los productos del usuario');
            console.log('- forceSyncClean(): Sincronización completa con limpieza');
            console.log('- removePhantomProduct(productId): Eliminar producto fantasma');
            console.log('- loadCategoriesInfo(): Cargar información de categorías desde la API');
            console.log('- Para usar: debugSystem() o debugProductDetails("MLA1234567890")');
            
            // ===== BACKGROUND SYNC FUNCTIONALITY =====
            window.startBackgroundSync = async function() {
                const syncBtn = document.getElementById('sync-btn');
                const syncText = document.getElementById('sync-text');
                const originalText = syncText.textContent;
                
                try {
                    // Deshabilitar botón y mostrar progreso
                    syncBtn.disabled = true;
                    syncBtn.className = 'btn btn-sm btn-info';
                    syncText.textContent = 'Sincronizando...';
                    
                    console.log('🔄 Iniciando sincronización background...');
                    
                    let continueSync = true;
                    let totalBatches = 0;
                    let totalProcessed = 0;
                    
                    while (continueSync) {
                        totalBatches++;
                        syncText.textContent = `Lote ${totalBatches}...`;
                        
                        const url = '/api/sync-next';
                        
                        console.log(`📦 Ejecutando lote ${totalBatches}: ${url}`);
                        
                        const response = await fetch(url);
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.error || 'Error en sincronización');
                        }
                        
                        console.log(`✅ Lote ${totalBatches} completado:`, result);
                        
                        totalProcessed += result.progress?.newInThisBatch || 0;
                        continueSync = result.hasMore || false;
                        
                        // Actualizar UI con progreso
                        if (result.progress) {
                            const percentage = result.progress.percentage || 0;
                            syncText.textContent = `${percentage}% (${result.progress.current}/${result.progress.total})`;
                        }
                        
                        // Si necesita continuar, pequeña pausa
                        if (continueSync) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                    
                    // Sincronización completada
                    console.log('🎉 Sincronización background completada!');
                    console.log(`📊 Total procesado: ${totalProcessed} productos en ${totalBatches} lotes`);
                    
                    syncBtn.className = 'btn btn-sm btn-success';
                    syncText.textContent = `✅ ${totalProcessed} nuevos`;
                    
                    // Recargar dashboard después de completar
                    setTimeout(() => {
                        console.log('🔄 Recargando dashboard...');
                        loadStatus(true);
                        
                        // Restaurar botón después de recargar
                        setTimeout(() => {
                            syncBtn.disabled = false;
                            syncBtn.className = 'btn btn-sm btn-warning';
                            syncText.textContent = originalText;
                        }, 3000);
                    }, 2000);
                    
                } catch (error) {
                    console.error('❌ Error en sincronización background:', error);
                    
                    // Mostrar error en botón
                    syncBtn.className = 'btn btn-sm btn-danger';
                    syncText.textContent = 'Error';
                    
                    alert(`Error en sincronización: ${error.message}`);
                    
                    // Restaurar botón después de error
                    setTimeout(() => {
                        syncBtn.disabled = false;
                        syncBtn.className = 'btn btn-sm btn-warning';
                        syncText.textContent = originalText;
                    }, 3000);
                }
            };
            
            console.log('🔄 Función de sincronización background agregada');
            console.log('- startBackgroundSync(): Iniciar sincronización por lotes');
            
            // ===== ALERTAS FUNCTIONALITY =====
            
            // Cargar alertas inicial
            loadAlerts();
            
            // Auto-refresh de alertas cada minuto
            setInterval(loadAlerts, 60000);
            
            // Event listeners para alertas
            document.getElementById('refresh-alerts').addEventListener('click', () => loadAlerts(null, true));
            document.getElementById('alert-settings-btn').addEventListener('click', toggleAlertSettings);
            document.getElementById('enable-popups').addEventListener('change', updateAlertSettings);
            document.getElementById('enable-sound').addEventListener('change', updateAlertSettings);
            document.getElementById('critical-only').addEventListener('change', updateAlertSettings);
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', function(event) {
                const notificationDropdown = document.getElementById('notification-dropdown');
                const notificationBell = document.querySelector('.notification-bell');
                
                if (!notificationBell.contains(event.target)) {
                    notificationDropdown.classList.remove('show');
                }
            });
            
            console.log('🔔 Sistema de alertas inicializado');
        });
        
        // ===== FUNCIONES DE ALERTAS =====
        
        /**
         * Cargar alertas desde la API
         */
        async function loadAlerts(page = null, forceRefresh = false) {
            if (page === 'prev') {
                alertsPage = Math.max(0, alertsPage - 1);
            } else if (page === 'next') {
                alertsPage++;
            } else if (page === null && !forceRefresh && alertsLoaded) {
                return; // Ya están cargadas
            }
            
            try {
                const priorityParam = currentAlertFilter === 'all' ? '' : `&priority=${currentAlertFilter}`;
                const response = await fetch(`/api/alerts?limit=${alertsPerPage}&offset=${alertsPage * alertsPerPage}${priorityParam}`);
                const data = await response.json();
                
                if (data.success) {
                    alertsData = data.alerts || [];
                    alertsLoaded = true;
                    
                    // Actualizar campanita
                    updateNotificationBell(data.summary);
                    
                    // Actualizar sidebar
                    updateSidebarAlertCount(data.summary.critical);
                    
                    // Si estamos en la sección de alertas, actualizar tabla
                    if (currentSection === 'alerts') {
                        updateAlertsTable(alertsData);
                        updateAlertFilters(data.counts);
                        updateAlertsPagination(data.pagination);
                    }
                    
                    // Actualizar dropdown de notificaciones
                    updateNotificationDropdown(alertsData.slice(0, 5)); // Solo las primeras 5
                    
                    // Mostrar popup si hay alertas críticas nuevas
                    if (alertSettings.popupsEnabled && data.summary.critical > 0) {
                        showCriticalAlertPopup(alertsData.filter(a => a.priority === 'critical'));
                    }
                    
                    console.log('🔔 Alertas cargadas:', data.summary);
                } else {
                    console.error('Error cargando alertas:', data.error);
                }
            } catch (error) {
                console.error('Error cargando alertas:', error);
            }
        }
        
        /**
         * Actualizar campanita de notificaciones
         */
        function updateNotificationBell(summary) {
            const badge = document.getElementById('notification-badge');
            const criticalCount = summary.critical || 0;
            
            if (criticalCount > 0) {
                badge.textContent = criticalCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        /**
         * Actualizar contador en sidebar
         */
        function updateSidebarAlertCount(criticalCount) {
            const sidebarCount = document.getElementById('sidebar-alert-count');
            if (criticalCount > 0) {
                sidebarCount.textContent = criticalCount;
                sidebarCount.style.display = 'inline-block';
            } else {
                sidebarCount.style.display = 'none';
            }
        }
        
        /**
         * Actualizar dropdown de notificaciones
         */
        function updateNotificationDropdown(alerts) {
            const body = document.getElementById('notification-body');
            
            if (alerts.length === 0) {
                body.innerHTML = '<div class="text-center p-3"><i class="bi bi-check-circle text-success"></i><div class="mt-2">No hay alertas</div></div>';
                return;
            }
            
            body.innerHTML = alerts.map(alert => `
                <div class="notification-item d-flex align-items-start ${alert.priority}" onclick="viewAlertDetail('${alert.id}')">
                    <div class="notification-icon">${alert.icon}</div>
                    <div class="notification-content">
                        <div class="notification-title">${alert.title}</div>
                        <div class="notification-description">${alert.description}</div>
                        <div class="notification-time">${alert.timeAgo}</div>
                    </div>
                </div>
            `).join('');
        }
        
        /**
         * Actualizar tabla de alertas
         */
        function updateAlertsTable(alerts) {
            const tbody = document.getElementById('alerts-table');
            
            if (alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay alertas para mostrar</td></tr>';
                return;
            }
            
            tbody.innerHTML = alerts.map(alert => `
                <tr class="alert-row ${alert.priority}" onclick="viewAlertDetail('${alert.id}')">
                    <td>
                        <span class="alert-priority-badge ${alert.priority}">
                            ${alert.icon} ${alert.title}
                        </span>
                    </td>
                    <td>
                        <div class="product-title">${alert.product_title}</div>
                        <small class="text-muted">ID: ${alert.product_id}</small>
                    </td>
                    <td>
                        <span class="badge ${alert.seller_sku ? 'bg-info' : 'bg-secondary'}" style="font-size: 0.75rem;">
                            ${alert.seller_sku || 'Sin SKU'}
                        </span>
                    </td>
                    <td>${alert.previous_stock}</td>
                    <td>
                        <span class="badge ${alert.priority === 'critical' ? 'bg-danger' : alert.priority === 'warning' ? 'bg-warning' : 'bg-success'}">
                            ${alert.new_stock}
                        </span>
                    </td>
                    <td>
                        <div>${alert.timeAgo}</div>
                        <small class="text-muted">${alert.formattedTime}</small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewAlertDetail('${alert.id}'); event.stopPropagation();" title="Ver detalles">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        /**
         * Actualizar filtros de alertas
         */
        function updateAlertFilters(counts) {
            document.getElementById('count-all').textContent = counts.total || 0;
            document.getElementById('count-critical').textContent = counts.LOW_STOCK || 0;
            document.getElementById('count-warning').textContent = counts.STOCK_DECREASE || 0;
            document.getElementById('count-info').textContent = counts.STOCK_INCREASE || 0;
        }
        
        /**
         * Actualizar paginación de alertas
         */
        function updateAlertsPagination(pagination) {
            const info = document.getElementById('alerts-pagination-info');
            const prevBtn = document.getElementById('alerts-prev-page');
            const nextBtn = document.getElementById('alerts-next-page');
            
            const start = (alertsPage * alertsPerPage) + 1;
            const end = Math.min(start + alertsPerPage - 1, start + alertsData.length - 1);
            
            info.textContent = `Mostrando ${start}-${end} de ${alertsData.length} alertas`;
            
            prevBtn.style.display = alertsPage > 0 ? 'block' : 'none';
            nextBtn.style.display = pagination.hasMore ? 'block' : 'none';
        }
        
        /**
         * Filtrar alertas por tipo
         */
        function filterAlerts(filter) {
            currentAlertFilter = filter;
            alertsPage = 0;
            
            // Actualizar botones activos
            document.querySelectorAll('.alert-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // Recargar alertas
            loadAlerts(null, true);
        }
        
        /**
         * Mostrar/ocultar dropdown de notificaciones
         */
        function toggleNotifications() {
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('show');
            
            // Cargar alertas recientes si se abre
            if (dropdown.classList.contains('show')) {
                loadAlerts(null, true);
            }
        }
        
        /**
         * Navegar a la sección de alertas
         */
        function viewAllAlerts() {
            showSection('alerts');
            toggleNotifications(); // Cerrar dropdown
        }
        
        /**
         * Mostrar/ocultar panel de configuración
         */
        function toggleAlertSettings() {
            const panel = document.getElementById('alert-settings-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        /**
         * Cargar configuración de alertas desde el servidor
         */
        async function loadAlertSettings() {
            try {
                const response = await fetch('/api/alert-settings');
                const data = await response.json();
                
                if (data.success) {
                    alertSettings = { ...alertSettings, ...data.settings };
                    
                    // Actualizar formulario
                    document.getElementById('enable-popups').checked = alertSettings.popupsEnabled;
                    document.getElementById('enable-sound').checked = alertSettings.soundEnabled;
                    document.getElementById('critical-only').checked = alertSettings.criticalOnly;
                    
                    console.log('⚙️ Configuración de alertas cargada:', alertSettings);
                }
            } catch (error) {
                console.error('Error cargando configuración de alertas:', error);
            }
        }

        /**
         * Actualizar configuración de alertas
         */
        function updateAlertSettings() {
            alertSettings.popupsEnabled = document.getElementById('enable-popups').checked;
            alertSettings.soundEnabled = document.getElementById('enable-sound').checked;
            alertSettings.criticalOnly = document.getElementById('critical-only').checked;
            
            console.log('⚙️ Configuración de alertas actualizada:', alertSettings);
        }
        
        /**
         * Guardar configuración de alertas
         */
        async function saveAlertSettings() {
            try {
                // Actualizar configuración desde el formulario
                updateAlertSettings();
                
                const response = await fetch('/api/alert-settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ settings: alertSettings })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Configuración guardada exitosamente');
                    toggleAlertSettings();
                } else {
                    alert('Error guardando configuración: ' + data.error);
                }
            } catch (error) {
                console.error('Error guardando configuración:', error);
                alert('Error guardando configuración');
            }
        }
        
        /**
         * Mostrar popup de alerta crítica
         */
        function showCriticalAlertPopup(criticalAlerts) {
            if (criticalAlerts.length === 0) return;
            
            const alert = criticalAlerts[0]; // Mostrar la primera alerta crítica
            
            // Crear popup
            const popup = document.createElement('div');
            popup.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            popup.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 350px;';
            
            popup.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="me-3 fs-4">${alert.icon}</div>
                    <div>
                        <h6 class="alert-heading mb-1">${alert.title}</h6>
                        <p class="mb-1">${alert.description}</p>
                        <small class="text-muted">${alert.timeAgo}</small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(popup);
            
            // Auto-remover después de 10 segundos
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            }, 10000);
            
            // Sonido si está habilitado
            if (alertSettings.soundEnabled) {
                playNotificationSound();
            }
        }
        
        /**
         * Reproducir sonido de notificación
         */
        function playNotificationSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMeAjuK2/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+Dyvmze');
            audio.volume = 0.3;
            audio.play().catch(e => console.log('No se pudo reproducir el sonido:', e));
        }
        
        /**
         * Ver detalles de una alerta
         */
        function viewAlertDetail(alertId) {
            const alert = alertsData.find(a => a.id === alertId);
            if (!alert) return;
            
            const modal = `
                <div class="modal fade" id="alertDetailModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${alert.icon} ${alert.title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Producto</h6>
                                        <p>${alert.product_title}</p>
                                        <p><small class="text-muted">ID: ${alert.product_id}</small></p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>SKU</h6>
                                        <p>${alert.seller_sku || 'Sin SKU'}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Stock Anterior</h6>
                                        <p>${alert.previous_stock} unidades</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Stock Actual</h6>
                                        <p class="text-${alert.priority === 'critical' ? 'danger' : alert.priority === 'warning' ? 'warning' : 'success'}">
                                            ${alert.new_stock} unidades
                                        </p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <h6>Descripción</h6>
                                        <p>${alert.description}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <h6>Tiempo</h6>
                                        <p>${alert.timeAgo} (${alert.formattedTime})</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                <button type="button" class="btn btn-primary" onclick="checkProduct('${alert.product_id}')">
                                    Ver producto
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior si existe
            const existingModal = document.getElementById('alertDetailModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Mostrar modal
            const bootstrapModal = new bootstrap.Modal(document.getElementById('alertDetailModal'));
            bootstrapModal.show();
        }
        
        /**
         * Navegar entre secciones
         */
        function showSection(sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Mostrar sección seleccionada
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Actualizar navegación activa
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[onclick="showSection('${sectionName}')"]`).classList.add('active');
            
            // Actualizar sección actual
            currentSection = sectionName;
            
            // Cargar datos específicos de la sección
            if (sectionName === 'alerts') {
                loadAlerts(null, true);
            } else if (sectionName === 'sessions') {
                refreshSessions();
            }
        }
        
        /**
         * Cargar y mostrar sesiones activas
         */
        async function refreshSessions() {
            const loadingDiv = document.getElementById('sessions-loading');
            const contentDiv = document.getElementById('sessions-content');
            const errorDiv = document.getElementById('sessions-error');
            
            // Mostrar loading, ocultar contenido y error
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/admin/api/sessions-detailed');
                const data = await response.json();
                
                if (data.success) {
                    updateSessionsUI(data);
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error cargando sesiones:', error);
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
            }
        }
        
        /**
         * Actualizar interfaz con datos de sesiones
         */
        function updateSessionsUI(data) {
            // Actualizar estadísticas
            document.getElementById('total-sessions-stat').textContent = data.stats.totalSessions;
            document.getElementById('unique-users-stat').textContent = data.stats.uniqueUsers;
            document.getElementById('unique-ips-stat').textContent = data.stats.uniqueIPs;
            document.getElementById('expiring-sessions-stat').textContent = data.stats.expiringSoon;
            
            // Actualizar badge en sidebar
            document.getElementById('active-sessions-count').textContent = data.stats.totalSessions;
            
            // Generar HTML para sesiones por usuario
            const container = document.getElementById('sessions-by-user');
            let html = '';
            
            Object.keys(data.sessionsByUser).forEach(userId => {
                const userSessions = data.sessionsByUser[userId];
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-person-circle"></i> Usuario: ${userId} 
                                <span class="badge bg-primary ms-2">${userSessions.length} sesión(es)</span>
                            </h6>
                        </div>
                        <div class="card-body">
                `;
                
                userSessions.forEach(session => {
                    const deviceInfo = parseUserAgent(session.userAgent);
                    const timeLeftClass = session.timeLeft < 5 ? 'text-danger' : (session.timeLeft < 15 ? 'text-warning' : 'text-success');
                    
                    html += `
                        <div class="row border-bottom pb-3 mb-3">
                            <div class="col-md-6">
                                <strong><i class="bi bi-laptop"></i> Dispositivo:</strong><br>
                                <small class="text-muted">${deviceInfo}</small><br>
                                <strong><i class="bi bi-geo-alt"></i> IP:</strong> 
                                <code>${session.ipAddress}</code>
                            </div>
                            <div class="col-md-3">
                                <strong><i class="bi bi-clock"></i> Último uso:</strong><br>
                                <small>${session.lastUsedMinutes} min atrás</small><br>
                                <strong><i class="bi bi-hourglass"></i> Expira en:</strong><br>
                                <span class="${timeLeftClass}"><strong>${session.timeLeft} min</strong></span>
                            </div>
                            <div class="col-md-3 text-end">
                                <small class="text-muted">ID: ${session.sessionIdShort}</small><br>
                                <button class="btn btn-sm btn-outline-danger mt-2" 
                                        onclick="revokeUserSession('${userId}')">
                                    <i class="bi bi-x-circle"></i> Revocar Usuario
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            if (html === '') {
                html = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> No hay sesiones activas en este momento.</div>';
            }
            
            container.innerHTML = html;
        }
        
        /**
         * Parsear User-Agent para mostrar información amigable
         */
        function parseUserAgent(userAgent) {
            if (!userAgent || userAgent === 'No disponible') {
                return 'Información no disponible';
            }
            
            let browser = 'Desconocido';
            let os = 'Desconocido';
            
            // Detectar navegador
            if (userAgent.includes('Chrome')) browser = 'Chrome';
            else if (userAgent.includes('Firefox')) browser = 'Firefox';
            else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) browser = 'Safari';
            else if (userAgent.includes('Edge')) browser = 'Edge';
            
            // Detectar OS
            if (userAgent.includes('Windows')) os = 'Windows';
            else if (userAgent.includes('Macintosh')) os = 'Mac';
            else if (userAgent.includes('Linux')) os = 'Linux';
            else if (userAgent.includes('Android')) os = 'Android';
            else if (userAgent.includes('iPhone')) os = 'iPhone';
            
            return `${browser} en ${os}`;
        }
        
        /**
         * Revocar todas las sesiones de un usuario
         */
        async function revokeUserSession(userId) {
            if (!confirm(`¿Estás seguro de que quieres revocar todas las sesiones del usuario ${userId}?`)) {
                return;
            }
            
            try {
                const response = await fetch('/admin/api/revoke-user-sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Se revocaron ${data.revokedCount} sesiones del usuario ${userId}`);
                    refreshSessions(); // Recargar la lista
                } else {
                    alert('Error revocando sesiones: ' + data.error);
                }
            } catch (error) {
                console.error('Error revocando sesiones:', error);
                alert('Error de conexión al revocar sesiones');
            }
        }
        
        // Hacer funciones globales disponibles
        window.loadAlerts = loadAlerts;
        window.filterAlerts = filterAlerts;
        window.toggleNotifications = toggleNotifications;
        window.viewAllAlerts = viewAllAlerts;
        window.toggleAlertSettings = toggleAlertSettings;
        window.saveAlertSettings = saveAlertSettings;
        window.showSection = showSection;
        window.viewAlertDetail = viewAlertDetail;
        window.refreshSessions = refreshSessions;
        window.revokeUserSession = revokeUserSession;
        
        /**
         * Limpiar webhooks antiguos
         */
        async function cleanupWebhooks() {
            const button = document.getElementById('cleanup-webhooks-btn');
            const originalText = button.innerHTML;
            
            if (!confirm('¿Estás seguro de que quieres limpiar los webhooks antiguos? Esto puede tomar unos minutos.')) {
                return;
            }
            
            try {
                // Deshabilitar botón y mostrar progreso
                button.disabled = true;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Limpiando...';
                
                console.log('🧹 Iniciando limpieza de webhooks...');
                
                const response = await fetch('/api/cleanup-webhooks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const results = data.results;
                    const message = `Limpieza completada exitosamente!\n\n` +
                                  `Webhooks antes: ${results.webhooksBefore}\n` +
                                  `Webhooks después: ${results.webhooksAfter}\n` +
                                  `Limpiados: ${results.cleaned}\n` +
                                  `Mejora: ${results.improvement}`;
                    
                    alert(message);
                    
                    // Actualizar alertas después de la limpieza
                    if (currentSection === 'alerts') {
                        loadAlerts(null, true);
                    }
                    
                    console.log('✅ Limpieza de webhooks completada:', results);
                } else {
                    alert('Error en la limpieza: ' + data.error);
                }
                
            } catch (error) {
                console.error('❌ Error limpiando webhooks:', error);
                alert('Error al limpiar webhooks: ' + error.message);
            } finally {
                // Restaurar botón
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        /**
         * Obtener estadísticas de webhooks
         */
        async function getWebhookStats() {
            try {
                const response = await fetch('/api/cleanup-webhooks');
                const data = await response.json();
                
                if (data.success) {
                    console.log('📊 Estadísticas de webhooks:', data.stats);
                    
                    if (data.recommendations && data.recommendations.length > 0) {
                        console.log('💡 Recomendaciones:', data.recommendations);
                        
                        // TODO: Implementar cuando se cree perfil de administrador
                        // const criticalRecommendations = data.recommendations.filter(r => r.priority === 'critical');
                        // if (criticalRecommendations.length > 0) {
                        //     const message = criticalRecommendations.map(r => `${r.message}\nAcción: ${r.action}`).join('\n\n');
                        //     alert('⚠️ Recomendaciones críticas:\n\n' + message);
                        // }
                    }
                    
                    return data;
                } else {
                    console.error('Error obteniendo estadísticas:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('Error obteniendo estadísticas:', error);
                return null;
            }
        }
        
        // Hacer funciones globales disponibles
        window.cleanupWebhooks = cleanupWebhooks;
        window.getWebhookStats = getWebhookStats;
        
        // Verificar estadísticas al cargar la página
        setTimeout(() => {
            getWebhookStats();
        }, 5000); // Esperar 5 segundos después de cargar
    </script>
</body>
</html>